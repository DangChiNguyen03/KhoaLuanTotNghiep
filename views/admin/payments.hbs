{{#section 'title'}}Quản lý thanh toán{{/section}}

<style>
    tbody tr td:last-child {
        text-align: right;
    }
</style>

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-money-bill-wave me-2"></i>Quản lý thanh toán</h2>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="/admin/dashboard">Dashboard</a></li>
                        <li class="breadcrumb-item active">Thanh toán</li>
                    </ol>
                </nav>
            </div>

            {{> messages}}

            <!-- Thống kê trạng thái -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card bg-primary text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4 class="card-title">{{statusStats.all}}</h4>
                                    <p class="card-text">Tổng giao dịch</p>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-money-bill-wave fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-warning text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4 class="card-title">{{statusStats.pending}}</h4>
                                    <p class="card-text">Chờ xử lý</p>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-clock fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-success text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4 class="card-title">{{statusStats.paid}}</h4>
                                    <p class="card-text">Đã thanh toán</p>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-check-circle fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-danger text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4 class="card-title">{{statusStats.cancelled}}</h4>
                                    <p class="card-text">Đã hủy</p>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-times-circle fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Bộ lọc -->
            <div class="card mb-4">
                <div class="card-body">
                    <form method="GET" action="/admin/payments" class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label">Trạng thái</label>
                            <select class="form-select" name="status">
                                <option value="">Tất cả trạng thái</option>
                                <option value="pending" {{#if (eq status 'pending')}}selected{{/if}}>Chờ xử lý</option>
                                <option value="paid" {{#if (eq status 'paid')}}selected{{/if}}>Đã thanh toán</option>
                                <option value="failed" {{#if (eq status 'failed')}}selected{{/if}}>Thất bại</option>
                                <option value="refunded" {{#if (eq status 'refunded')}}selected{{/if}}>Đã hoàn tiền</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Phương thức</label>
                            <select class="form-select" name="paymentMethod">
                                <option value="">Tất cả phương thức</option>
                                <option value="cash" {{#if (eq paymentMethod 'cash')}}selected{{/if}}>Tiền mặt</option>
                                <option value="vnpay" {{#if (eq paymentMethod 'vnpay')}}selected{{/if}}>VNPay</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Tìm kiếm</label>
                            <input type="text" class="form-control" name="search" placeholder="Tìm kiếm theo mã giao dịch, tên khách hàng..." value="{{search}}">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">&nbsp;</label>
                            <div class="d-grid">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-search"></i> Lọc
                                </button>
                            </div>
                        </div>
                    </form>
                    {{#if (or status paymentMethod search)}}
                    <div class="mt-2">
                        <a href="/admin/payments" class="btn btn-secondary btn-sm">
                            <i class="fas fa-times"></i> Xóa bộ lọc
                        </a>
                    </div>
                    {{/if}}
                </div>
            </div>

            <!-- Danh sách thanh toán -->
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Danh sách giao dịch thanh toán</h5>
                </div>
                <div class="card-body">
                    {{#if payments.length}}
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Mã GD</th>
                                    <th>Khách hàng</th>
                                    <th>Đơn hàng</th>
                                    <th>Số tiền</th>
                                    <th>Phương thức</th>
                                    <th>Trạng thái</th>
                                    <th>Ngày tạo</th>
                                    <th>Thao tác</th>
                                </tr>
                            </thead>
                            <tbody>
                                {{#each payments}}
                                <tr>
                                    <td>
                                        <code>#{{substring this._id 0 8}}</code>
                                        {{#if this.transactionId}}
                                        <br><small class="text-muted">{{this.transactionId}}</small>
                                        {{/if}}
                                    </td>
                                    <td>
                                        <div>
                                            <strong>{{this.user.name}}</strong>
                                            <br>
                                            <small class="text-muted">{{this.user.email}}</small>
                                            {{#if this.user.phone}}
                                            <br>
                                            <small class="text-muted">{{this.user.phone}}</small>
                                            {{/if}}
                                        </div>
                                    </td>
                                    <td>
                                        {{#if this.order}}
                                        <div>
                                            <strong>{{formatPrice this.order.totalPrice}}</strong>
                                            <br>
                                            <small class="text-muted">{{formatDateTime this.order.createdAt}}</small>
                                        </div>
                                        {{else}}
                                        <span class="text-muted">Không có</span>
                                        {{/if}}
                                    </td>
                                    <td>
                                        <strong class="text-success">{{formatPrice this.amount}}</strong>
                                    </td>
                                    <td>
                                        <span class="badge {{#if (eq this.paymentMethod 'cash')}}bg-success{{else if (eq this.paymentMethod 'bank')}}bg-info{{else}}bg-warning{{/if}}">
                                            {{#if (eq this.paymentMethod 'cash')}}Tiền mặt
                                            {{else if (eq this.paymentMethod 'bank')}}VNPay
                                            {{else if (eq this.paymentMethod 'momo')}}MoMo
                                            {{else if (eq this.paymentMethod 'zalopay')}}ZaloPay
                                            {{else if (eq this.paymentMethod 'vnpay')}}VNPay
                                            {{else}}{{this.paymentMethod}}{{/if}}
                                        </span>
                                    </td>
                                    <td>
                                        <span class="badge {{#if (eq this.status 'paid')}}bg-success{{else if (eq this.status 'pending')}}bg-warning{{else if (eq this.status 'failed')}}bg-danger{{else}}bg-secondary{{/if}}">
                                            {{#if (eq this.status 'paid')}}Đã thanh toán
                                            {{else if (eq this.status 'pending')}}Chờ xử lý
                                            {{else if (eq this.status 'failed')}}Thất bại
                                            {{else if (eq this.status 'refunded')}}Đã hoàn tiền
                                            {{else}}{{this.status}}{{/if}}
                                        </span>
                                        {{#if this.paidAt}}
                                        <br><small class="text-muted">{{formatDateTime this.paidAt}}</small>
                                        {{/if}}
                                    </td>
                                    <td>
                                        <small>{{formatDateTime this.createdAt}}</small>
                                    </td>
                                    <td>
                                        <div class="btn-group" role="group">
                                            {{#if (eq this.status 'pending')}}
                                            <button type="button" class="btn btn-sm btn-success" onclick="updatePaymentStatus('{{this._id}}', 'paid')" title="Đánh dấu đã thanh toán">
                                                <i class="fas fa-check"></i>
                                            </button>
                                            <button type="button" class="btn btn-sm btn-danger" onclick="updatePaymentStatus('{{this._id}}', 'failed')" title="Đánh dấu thất bại">
                                                <i class="fas fa-times"></i>
                                            </button>
                                            {{else if (eq this.status 'paid')}}
                                            {{#if this.order}}
                                                {{#if (eq this.order.status 'cancelled')}}
                                                <button type="button" class="btn btn-sm btn-warning" onclick="updatePaymentStatus('{{this._id}}', 'refunded')" title="Hoàn tiền cho đơn hàng đã hủy">
                                                    <i class="fas fa-undo"></i> Hoàn tiền
                                                </button>
                                                {{else if (eq this.order.status 'completed')}}
                                                <span class="text-success small">
                                                    <i class="fas fa-check-circle"></i> 
                                                    Đơn hàng hoàn thành
                                                </span>
                                                {{else if (eq this.order.status 'confirmed')}}
                                                <span class="text-info small">
                                                    <i class="fas fa-clock"></i> 
                                                    Đang xử lý
                                                </span>
                                                {{else}}
                                                <span class="text-muted small">
                                                    <i class="fas fa-info-circle"></i> 
                                                    Trạng thái: {{this.order.status}}
                                                </span>
                                                {{/if}}
                                            {{else}}
                                            <span class="text-warning small">
                                                <i class="fas fa-exclamation-triangle"></i> 
                                                Không có đơn hàng
                                            </span>
                                            {{/if}}
                                            {{else if (eq this.status 'refunded')}}
                                            <span class="text-success small">
                                                <i class="fas fa-check-double"></i> 
                                                Đã hoàn tiền
                                            </span>
                                            {{else if (eq this.status 'failed')}}
                                            <span class="text-danger small">
                                                <i class="fas fa-times-circle"></i> 
                                                Thanh toán thất bại
                                            </span>
                                            {{/if}}
                                            <button type="button" class="btn btn-sm btn-info" onclick="viewPaymentDetail('{{this._id}}')" title="Xem chi tiết">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {{/each}}
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    {{#if (gt totalPages 1)}}
                    <nav aria-label="Payment pagination">
                        <ul class="pagination justify-content-center">
                            {{#if (gt currentPage 1)}}
                            <li class="page-item">
                                <a class="page-link" href="/admin/payments?page={{subtract currentPage 1}}{{#if status}}&status={{status}}{{/if}}{{#if paymentMethod}}&paymentMethod={{paymentMethod}}{{/if}}{{#if search}}&search={{search}}{{/if}}">Trước</a>
                            </li>
                            {{/if}}
                            
                            {{#each (range 1 totalPages)}}
                            <li class="page-item {{#if (eq this ../currentPage)}}active{{/if}}">
                                <a class="page-link" href="/admin/payments?page={{this}}{{#if ../status}}&status={{../status}}{{/if}}{{#if ../paymentMethod}}&paymentMethod={{../paymentMethod}}{{/if}}{{#if ../search}}&search={{../search}}{{/if}}">{{this}}</a>
                            </li>
                            {{/each}}
                            
                            {{#if (lt currentPage totalPages)}}
                            <li class="page-item">
                                <a class="page-link" href="/admin/payments?page={{add currentPage 1}}{{#if status}}&status={{status}}{{/if}}{{#if paymentMethod}}&paymentMethod={{paymentMethod}}{{/if}}{{#if search}}&search={{search}}{{/if}}">Sau</a>
                            </li>
                            {{/if}}
                        </ul>
                    </nav>
                    {{/if}}

                    {{else}}
                    <div class="text-center py-5">
                        <i class="fas fa-money-bill-wave fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">
                            {{#if (or status paymentMethod search)}}
                            Không tìm thấy giao dịch nào
                            {{else}}
                            Chưa có giao dịch thanh toán nào
                            {{/if}}
                        </h5>
                        {{#if (or status paymentMethod search)}}
                        <a href="/admin/payments" class="btn btn-primary">Xem tất cả giao dịch</a>
                        {{/if}}
                    </div>
                    {{/if}}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal cập nhật trạng thái thanh toán -->
<div class="modal fade" id="updatePaymentStatusModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Cập nhật trạng thái thanh toán</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" id="updatePaymentStatusForm">
                <input type="hidden" name="_method" value="PUT">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Trạng thái</label>
                        <select class="form-select" name="status" id="paymentStatus" required>
                            <option value="pending">Chờ xử lý</option>
                            <option value="paid">Đã thanh toán</option>
                            <option value="failed">Thất bại</option>
                            <option value="refunded">Đã hoàn tiền</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Ghi chú</label>
                        <textarea class="form-control" name="notes" rows="3" placeholder="Ghi chú về việc cập nhật trạng thái..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="submit" class="btn btn-primary">Cập nhật</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Chi tiết giao dịch -->
<div class="modal fade" id="paymentDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-receipt me-2"></i>
                    Chi tiết giao dịch
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="paymentDetailContent">
                <div class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Đang tải...</span>
                    </div>
                    <p class="mt-2">Đang tải thông tin giao dịch...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
            </div>
        </div>
    </div>
</div>

<script>
function updatePaymentStatus(paymentId, status) {
    const statusText = {
        'paid': 'đã thanh toán',
        'failed': 'thất bại',
        'refunded': 'hoàn tiền'
    };
    
    let confirmMessage = `Bạn có chắc chắn muốn đánh dấu giao dịch này là ${statusText[status]}?`;
    
    // Thêm cảnh báo đặc biệt cho hoàn tiền
    if (status === 'refunded') {
        confirmMessage = `⚠️ HOÀN TIỀN\n\nBạn có chắc chắn muốn hoàn tiền cho giao dịch này?\n\n• Chỉ hoàn tiền cho đơn hàng đã bị hủy\n• Hành động này không thể hoàn tác\n• Tiền sẽ được hoàn lại cho khách hàng\n\nXác nhận hoàn tiền?`;
    }
    
    if (confirm(confirmMessage)) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/admin/payments/${paymentId}/status`;
        
        const methodInput = document.createElement('input');
        methodInput.type = 'hidden';
        methodInput.name = '_method';
        methodInput.value = 'PUT';
        
        const statusInput = document.createElement('input');
        statusInput.type = 'hidden';
        statusInput.name = 'status';
        statusInput.value = status;
        
        // Thêm ghi chú tự động cho hoàn tiền
        if (status === 'refunded') {
            const notesInput = document.createElement('input');
            notesInput.type = 'hidden';
            notesInput.name = 'notes';
            notesInput.value = `Hoàn tiền cho đơn hàng đã hủy - ${new Date().toLocaleString('vi-VN')}`;
            form.appendChild(notesInput);
        }
        
        form.appendChild(methodInput);
        form.appendChild(statusInput);
        document.body.appendChild(form);
        form.submit();
    }
}

function viewPaymentDetail(paymentId) {
    // Hiển thị modal
    const modal = new bootstrap.Modal(document.getElementById('paymentDetailModal'));
    modal.show();
    
    // Reset nội dung về loading state
    document.getElementById('paymentDetailContent').innerHTML = `
        <div class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Đang tải...</span>
            </div>
            <p class="mt-2">Đang tải thông tin giao dịch...</p>
        </div>
    `;
    
    // Gọi API để lấy chi tiết
    fetch(`/admin/payments/${paymentId}/detail`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayPaymentDetail(data.payment);
            } else {
                displayError(data.message || 'Không thể tải thông tin giao dịch');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            displayError('Lỗi kết nối. Vui lòng thử lại.');
        });
}

function displayPaymentDetail(payment) {
    const content = document.getElementById('paymentDetailContent');
    
    const statusBadge = getStatusBadge(payment.status);
    const methodBadge = getMethodBadge(payment.paymentMethod);
    
    content.innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>Thông tin cơ bản</h6>
                    </div>
                    <div class="card-body">
                        <table class="table table-borderless">
                            <tr>
                                <td><strong>Mã giao dịch:</strong></td>
                                <td><code>${payment._id}</code></td>
                            </tr>
                            <tr>
                                <td><strong>Số tiền:</strong></td>
                                <td><span class="text-success fw-bold">${formatPrice(payment.amount)}</span></td>
                            </tr>
                            <tr>
                                <td><strong>Trạng thái:</strong></td>
                                <td>${statusBadge}</td>
                            </tr>
                            <tr>
                                <td><strong>Phương thức:</strong></td>
                                <td>${methodBadge}</td>
                            </tr>
                            <tr>
                                <td><strong>Ngày tạo:</strong></td>
                                <td>${formatDateTime(payment.createdAt)}</td>
                            </tr>
                            ${payment.paidAt ? `
                            <tr>
                                <td><strong>Ngày thanh toán:</strong></td>
                                <td>${formatDateTime(payment.paidAt)}</td>
                            </tr>
                            ` : ''}
                        </table>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-user me-2"></i>Thông tin khách hàng</h6>
                    </div>
                    <div class="card-body">
                        ${payment.user ? `
                        <table class="table table-borderless">
                            <tr>
                                <td><strong>Tên:</strong></td>
                                <td>${payment.user.name}</td>
                            </tr>
                            <tr>
                                <td><strong>Email:</strong></td>
                                <td>${payment.user.email}</td>
                            </tr>
                            <tr>
                                <td><strong>Điện thoại:</strong></td>
                                <td>${payment.user.phone || 'Chưa cập nhật'}</td>
                            </tr>
                        </table>
                        ` : '<p class="text-muted">Không có thông tin khách hàng</p>'}
                    </div>
                </div>
            </div>
        </div>
        
        ${payment.order ? `
        <div class="row mt-3">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-shopping-cart me-2"></i>Thông tin đơn hàng</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <p><strong>Mã đơn hàng:</strong><br><code>${payment.order._id}</code></p>
                            </div>
                            <div class="col-md-4">
                                <p><strong>Tổng tiền:</strong><br><span class="text-success fw-bold">${formatPrice(payment.order.totalPrice)}</span></p>
                            </div>
                            <div class="col-md-4">
                                <p><strong>Trạng thái đơn hàng:</strong><br>${getOrderStatusBadge(payment.order.status)}</p>
                            </div>
                        </div>
                        ${payment.order.items && payment.order.items.length > 0 ? `
                        <h6 class="mt-3">Sản phẩm đã đặt:</h6>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Sản phẩm</th>
                                        <th>Size</th>
                                        <th>Số lượng</th>
                                        <th>Đơn giá</th>
                                        <th>Thành tiền</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${payment.order.items.map(item => `
                                    <tr>
                                        <td>${item.product ? item.product.name : 'Sản phẩm đã xóa'}</td>
                                        <td>${item.size || 'N/A'}</td>
                                        <td>${item.quantity}</td>
                                        <td>${formatPrice(item.price || 0)}</td>
                                        <td>${formatPrice((item.price || 0) * item.quantity)}</td>
                                    </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                        ` : ''}
                    </div>
                </div>
            </div>
        </div>
        ` : ''}
        
        ${payment.notes ? `
        <div class="row mt-3">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-sticky-note me-2"></i>Ghi chú</h6>
                    </div>
                    <div class="card-body">
                        <p class="mb-0">${payment.notes}</p>
                    </div>
                </div>
            </div>
        </div>
        ` : ''}
    `;
}

function displayError(message) {
    document.getElementById('paymentDetailContent').innerHTML = `
        <div class="text-center text-danger">
            <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
            <h5>Lỗi</h5>
            <p>${message}</p>
        </div>
    `;
}

function getStatusBadge(status) {
    const badges = {
        'pending': '<span class="badge bg-warning">Chờ xử lý</span>',
        'paid': '<span class="badge bg-success">Đã thanh toán</span>',
        'failed': '<span class="badge bg-danger">Thất bại</span>',
        'refunded': '<span class="badge bg-info">Đã hoàn tiền</span>'
    };
    return badges[status] || `<span class="badge bg-secondary">${status}</span>`;
}

function getMethodBadge(method) {
    const badges = {
        'cash': '<span class="badge bg-success"><i class="fas fa-money-bill-wave me-1"></i>Tiền mặt</span>',
        'vnpay': '<span class="badge bg-primary"><i class="fas fa-credit-card me-1"></i>VNPay</span>',
        'momo': '<span class="badge bg-danger"><i class="fas fa-mobile-alt me-1"></i>MoMo</span>'
    };
    return badges[method] || `<span class="badge bg-secondary">${method}</span>`;
}

function getOrderStatusBadge(status) {
    const badges = {
        'pending': '<span class="badge bg-warning">Chờ xử lý</span>',
        'confirmed': '<span class="badge bg-info">Đã xác nhận</span>',
        'completed': '<span class="badge bg-success">Hoàn thành</span>',
        'cancelled': '<span class="badge bg-danger">Đã hủy</span>'
    };
    return badges[status] || `<span class="badge bg-secondary">${status}</span>`;
}

function formatPrice(price) {
    return new Intl.NumberFormat('vi-VN', {
        style: 'currency',
        currency: 'VND'
    }).format(price);
}

function formatDateTime(dateString) {
    const date = new Date(dateString);
    return date.toLocaleString('vi-VN');
}
</script>
