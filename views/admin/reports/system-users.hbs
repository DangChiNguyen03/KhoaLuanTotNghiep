{{#section 'title'}}{{title}}{{/section}}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-users-cog me-2"></i>{{title}}</h2>
                <div>
                    <div class="btn-group" role="group">
                        <a href="?{{#each filters}}{{@key}}={{this}}&{{/each}}exportFormat=json" class="btn btn-outline-primary">
                            <i class="fas fa-download me-1"></i>Export JSON
                        </a>
                        <a href="?{{#each filters}}{{@key}}={{this}}&{{/each}}exportFormat=csv" class="btn btn-outline-success">
                            <i class="fas fa-file-csv me-1"></i>Export CSV
                        </a>
                    </div>
                </div>
            </div>

            <!-- Filters -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-filter me-2"></i>Bộ lọc báo cáo</h5>
                </div>
                <div class="card-body">
                    <form method="GET" action="/admin/reports/system-users">
                        <div class="row">
                            <div class="col-md-3">
                                <label class="form-label">Từ ngày</label>
                                <input type="date" class="form-control" name="startDate" value="{{formatDateInput dateRange.startDate}}">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Đến ngày</label>
                                <input type="date" class="form-control" name="endDate" value="{{formatDateInput dateRange.endDate}}">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Người dùng</label>
                                <select class="form-select" name="userId">
                                    <option value="">Tất cả</option>
                                    {{#each allSystemUsers}}
                                        <option value="{{this._id}}" {{#if (eq ../filters.userId this._id)}}selected{{/if}}>
                                            {{this.username}} ({{this.role}})
                                        </option>
                                    {{/each}}
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Hành động</label>
                                <select class="form-select" name="action">
                                    <option value="">Tất cả</option>
                                    <option value="login" {{#if (eq filters.action 'login')}}selected{{/if}}>Đăng nhập</option>
                                    <option value="logout" {{#if (eq filters.action 'logout')}}selected{{/if}}>Đăng xuất</option>
                                    <option value="create" {{#if (eq filters.action 'create')}}selected{{/if}}>Tạo mới</option>
                                    <option value="update" {{#if (eq filters.action 'update')}}selected{{/if}}>Cập nhật</option>
                                    <option value="delete" {{#if (eq filters.action 'delete')}}selected{{/if}}>Xóa</option>
                                    <option value="data_export" {{#if (eq filters.action 'data_export')}}selected{{/if}}>Xuất dữ liệu</option>
                                </select>
                            </div>
                            <div class="col-md-2 d-flex align-items-end">
                                <button type="submit" class="btn btn-primary me-2">
                                    <i class="fas fa-sync me-1"></i>Cập nhật
                                </button>
                                <a href="/admin/reports/system-users" class="btn btn-outline-secondary">
                                    <i class="fas fa-undo"></i>
                                </a>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Overview Statistics -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card bg-primary text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4>{{overview.totalActivities}}</h4>
                                    <p class="mb-0">Tổng hoạt động</p>
                                    <small>Trong kỳ báo cáo</small>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-chart-bar fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-success text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4>{{overview.uniqueUsers}}</h4>
                                    <p class="mb-0">Người dùng hoạt động</p>
                                    <small>Duy nhất</small>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-users fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-info text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4>{{overview.successRate}}%</h4>
                                    <p class="mb-0">Tỷ lệ thành công</p>
                                    <small>{{overview.successfulActions}}/{{overview.totalActivities}}</small>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-check-circle fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-warning text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4>{{overview.suspiciousActivities}}</h4>
                                    <p class="mb-0">Hoạt động đáng ngờ</p>
                                    <small>Cần kiểm tra</small>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-exclamation-triangle fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts Row -->
            <div class="row mb-4">
                <!-- Daily Activity Trend -->
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>Xu hướng hoạt động theo ngày</h5>
                        </div>
                        <div class="card-body">
                            <canvas id="dailyActivityChart" height="100"></canvas>
                        </div>
                    </div>
                </div>
                
                <!-- Action Breakdown -->
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-chart-pie me-2"></i>Phân loại hành động</h5>
                        </div>
                        <div class="card-body">
                            <canvas id="actionBreakdownChart" height="200"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Activity Patterns -->
            <div class="row mb-4">
                <!-- Hourly Activity Pattern -->
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-clock me-2"></i>Mẫu hoạt động theo giờ</h5>
                        </div>
                        <div class="card-body">
                            <canvas id="hourlyActivityChart" height="100"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Most Active Users -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-user-tie me-2"></i>Top 20 Người dùng hoạt động nhiều nhất</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>#</th>
                                    <th>Người dùng</th>
                                    <th>Vai trò</th>
                                    <th>Tổng hoạt động</th>
                                    <th>Thành công</th>
                                    <th>Thất bại</th>
                                    <th>Đáng ngờ</th>
                                    <th>Tỷ lệ thành công</th>
                                    <th>Hoạt động cuối</th>
                                </tr>
                            </thead>
                            <tbody>
                                {{#each mostActiveUsers}}
                                <tr>
                                    <td><strong>{{add @index 1}}</strong></td>
                                    <td>
                                        <div>
                                            <strong>{{this.username}}</strong>
                                            <br><small class="text-muted">{{this.email}}</small>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="badge {{#if (eq this.role 'admin')}}bg-danger{{else if (eq this.role 'manager')}}bg-warning{{else}}bg-info{{/if}}">
                                            {{this.role}}
                                        </span>
                                    </td>
                                    <td>
                                        <span class="badge bg-primary">{{this.totalActivities}}</span>
                                    </td>
                                    <td>
                                        <span class="text-success">{{this.successfulActions}}</span>
                                    </td>
                                    <td>
                                        <span class="text-danger">{{this.failedActions}}</span>
                                    </td>
                                    <td>
                                        {{#if (gt this.suspiciousActivities 0)}}
                                            <span class="badge bg-warning">{{this.suspiciousActivities}}</span>
                                        {{else}}
                                            <span class="text-muted">0</span>
                                        {{/if}}
                                    </td>
                                    <td>
                                        <div class="progress" style="width: 80px;">
                                            <div class="progress-bar {{#if (gt this.successRate 90)}}bg-success{{else if (gt this.successRate 70)}}bg-warning{{else}}bg-danger{{/if}}" 
                                                 role="progressbar" style="width: {{this.successRate}}%">
                                                {{this.successRate}}%
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <small>{{formatDateTime this.lastActivity}}</small>
                                    </td>
                                </tr>
                                {{/each}}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Action Breakdown & Resource Access -->
            <div class="row mb-4">
                <!-- Action Breakdown Table -->
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-tasks me-2"></i>Phân tích hành động</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>Hành động</th>
                                            <th>Số lần</th>
                                            <th>Người dùng</th>
                                            <th>Tỷ lệ thành công</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {{#each actionBreakdown}}
                                        <tr>
                                            <td><strong>{{this.action}}</strong></td>
                                            <td><span class="badge bg-primary">{{this.count}}</span></td>
                                            <td><span class="text-info">{{this.uniqueUsers}}</span></td>
                                            <td>
                                                <div class="progress" style="width: 60px;">
                                                    <div class="progress-bar {{#if (gt this.successRate 90)}}bg-success{{else if (gt this.successRate 70)}}bg-warning{{else}}bg-danger{{/if}}" 
                                                         role="progressbar" style="width: {{this.successRate}}%">
                                                    </div>
                                                </div>
                                                <small>{{this.successRate}}%</small>
                                            </td>
                                        </tr>
                                        {{/each}}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Resource Access -->
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-database me-2"></i>Tài nguyên được truy cập nhiều nhất</h5>
                        </div>
                        <div class="card-body">
                            {{#each resourceAccess}}
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <div>
                                    <strong>{{this.resource}}</strong>
                                    <br><small class="text-muted">{{this.uniqueUsers}} người dùng, {{this.uniqueActions}} hành động</small>
                                </div>
                                <div class="text-end">
                                    <span class="badge bg-primary">{{this.accessCount}}</span>
                                    <br><small class="text-muted">{{formatDateTime this.lastAccess}}</small>
                                </div>
                            </div>
                            {{#unless @last}}<hr>{{/unless}}
                            {{/each}}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Failed Login Attempts -->
            {{#if failedLogins}}
            <div class="card mb-4">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0"><i class="fas fa-shield-alt me-2"></i>Các lần đăng nhập thất bại</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Người dùng</th>
                                    <th>Email</th>
                                    <th>IP Address</th>
                                    <th>Số lần thử</th>
                                    <th>Lần cuối</th>
                                    <th>User Agent</th>
                                </tr>
                            </thead>
                            <tbody>
                                {{#each failedLogins}}
                                <tr>
                                    <td><strong>{{this.username}}</strong></td>
                                    <td><small>{{this.email}}</small></td>
                                    <td>
                                        <code>{{this.ip}}</code>
                                    </td>
                                    <td>
                                        <span class="badge {{#if (gt this.attemptCount 5)}}bg-danger{{else if (gt this.attemptCount 2)}}bg-warning{{else}}bg-secondary{{/if}}">
                                            {{this.attemptCount}} lần
                                        </span>
                                    </td>
                                    <td>
                                        <small>{{formatDateTime this.lastAttempt}}</small>
                                    </td>
                                    <td>
                                        <small class="text-muted">{{truncate this.userAgent 50}}</small>
                                    </td>
                                </tr>
                                {{/each}}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            {{/if}}
        </div>
    </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
// Daily Activity Chart
const dailyActivityData = {{{json dailyActivity}}};
const dailyLabels = dailyActivityData.map(item => item._id);
const dailyTotalActivities = dailyActivityData.map(item => item.totalActivities);
const dailyUniqueUsers = dailyActivityData.map(item => item.uniqueUsers);
const dailySuspicious = dailyActivityData.map(item => item.suspiciousActivities);

const dailyCtx = document.getElementById('dailyActivityChart').getContext('2d');
new Chart(dailyCtx, {
    type: 'line',
    data: {
        labels: dailyLabels,
        datasets: [{
            label: 'Tổng hoạt động',
            data: dailyTotalActivities,
            borderColor: 'rgb(75, 192, 192)',
            backgroundColor: 'rgba(75, 192, 192, 0.2)',
            yAxisID: 'y'
        }, {
            label: 'Người dùng hoạt động',
            data: dailyUniqueUsers,
            borderColor: 'rgb(54, 162, 235)',
            backgroundColor: 'rgba(54, 162, 235, 0.2)',
            yAxisID: 'y'
        }, {
            label: 'Hoạt động đáng ngờ',
            data: dailySuspicious,
            borderColor: 'rgb(255, 99, 132)',
            backgroundColor: 'rgba(255, 99, 132, 0.2)',
            yAxisID: 'y'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: {
                beginAtZero: true
            }
        }
    }
});

// Action Breakdown Chart
const actionData = {{{json actionBreakdown}}};
const actionLabels = actionData.map(item => item.action);
const actionCounts = actionData.map(item => item.count);

const actionCtx = document.getElementById('actionBreakdownChart').getContext('2d');
new Chart(actionCtx, {
    type: 'doughnut',
    data: {
        labels: actionLabels,
        datasets: [{
            data: actionCounts,
            backgroundColor: [
                '#FF6384',
                '#36A2EB',
                '#FFCE56',
                '#4BC0C0',
                '#9966FF',
                '#FF9F40',
                '#FF6384',
                '#C9CBCF'
            ]
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom'
            }
        }
    }
});

// Hourly Activity Chart
const hourlyData = {{{json hourlyActivity}}};
const hourLabels = Array.from({length: 24}, (_, i) => i + 'h');
const hourlyCounts = hourLabels.map(hour => {
    const hourNum = parseInt(hour);
    const found = hourlyData.find(item => item.hour === hourNum);
    return found ? found.count : 0;
});

const hourlyCtx = document.getElementById('hourlyActivityChart').getContext('2d');
new Chart(hourlyCtx, {
    type: 'bar',
    data: {
        labels: hourLabels,
        datasets: [{
            label: 'Số hoạt động',
            data: hourlyCounts,
            backgroundColor: 'rgba(153, 102, 255, 0.5)',
            borderColor: 'rgba(153, 102, 255, 1)',
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: {
                beginAtZero: true
            }
        }
    }
});
</script>

{{#section 'styles'}}
<style>
.card {
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
}

.table th {
    border-top: none;
}

.progress {
    border-radius: 0.5rem;
}

.badge {
    font-size: 0.75em;
}

code {
    background-color: #f8f9fa;
    padding: 0.2rem 0.4rem;
    border-radius: 0.25rem;
    font-size: 0.875em;
}
</style>
{{/section}}
