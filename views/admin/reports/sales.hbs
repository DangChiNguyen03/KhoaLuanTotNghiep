{{#section 'title'}}{{title}}{{/section}}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-chart-line me-2"></i>{{title}}</h2>
                <div>
                    <div class="btn-group" role="group">
                        <a href="?{{#each filters}}{{@key}}={{this}}&{{/each}}exportFormat=json" class="btn btn-outline-primary">
                            <i class="fas fa-download me-1"></i>Export JSON
                        </a>
                        <a href="?{{#each filters}}{{@key}}={{this}}&{{/each}}exportFormat=csv" class="btn btn-outline-success">
                            <i class="fas fa-file-csv me-1"></i>Export CSV
                        </a>
                    </div>
                </div>
            </div>

            <!-- Filters -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-filter me-2"></i>Bộ lọc báo cáo</h5>
                </div>
                <div class="card-body">
                    <form method="GET" action="/admin/reports/sales">
                        <div class="row">
                            <div class="col-md-3">
                                <label class="form-label">Từ ngày</label>
                                <input type="date" class="form-control" name="startDate" value="{{formatDateInput dateRange.startDate}}">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Đến ngày</label>
                                <input type="date" class="form-control" name="endDate" value="{{formatDateInput dateRange.endDate}}">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Kỳ báo cáo</label>
                                <select class="form-select" name="period">
                                    <option value="daily" {{#if (eq filters.period 'daily')}}selected{{/if}}>Theo ngày</option>
                                    <option value="weekly" {{#if (eq filters.period 'weekly')}}selected{{/if}}>Theo tuần</option>
                                    <option value="monthly" {{#if (eq filters.period 'monthly')}}selected{{/if}}>Theo tháng</option>
                                </select>
                            </div>
                            <div class="col-md-3 d-flex align-items-end">
                                <button type="submit" class="btn btn-primary me-2">
                                    <i class="fas fa-sync me-1"></i>Cập nhật
                                </button>
                                <a href="/admin/reports/sales" class="btn btn-outline-secondary">
                                    <i class="fas fa-undo"></i>
                                </a>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Overview Statistics -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card bg-primary text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4>{{overview.totalOrders}}</h4>
                                    <p class="mb-0">Tổng đơn hàng</p>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-shopping-cart fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-success text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4>{{formatCurrency overview.totalRevenue}}</h4>
                                    <p class="mb-0">Tổng doanh thu</p>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-dollar-sign fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-info text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4>{{formatCurrency overview.avgOrderValue}}</h4>
                                    <p class="mb-0">Giá trị đơn TB</p>
                                    <small>Trung bình mỗi đơn</small>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-receipt fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-warning text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4>{{overview.completedOrders}}</h4>
                                    <p class="mb-0">Đơn hoàn thành</p>
                                    <small>{{divide (multiply overview.completedOrders 100) overview.totalOrders}}% tỷ lệ</small>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-check-circle fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts Row -->
            <div class="row mb-4">
                <!-- Daily Sales Trend -->
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>Xu hướng doanh số theo ngày</h5>
                        </div>
                        <div class="card-body">
                            <canvas id="dailySalesChart" height="100"></canvas>
                        </div>
                    </div>
                </div>
                
                <!-- Revenue by Category -->
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-chart-pie me-2"></i>Doanh thu theo danh mục</h5>
                        </div>
                        <div class="card-body">
                            <canvas id="categoryRevenueChart" height="200"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sales Patterns -->
            <div class="row mb-4">
                <!-- Hourly Sales Pattern -->
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-clock me-2"></i>Mẫu bán hàng theo giờ</h5>
                            <small class="text-muted">Hôm nay ({{formatDate today}})</small>
                        </div>
                        <div class="card-body">
                            <canvas id="hourlySalesChart" height="150"></canvas>
                        </div>
                    </div>
                </div>
                
                <!-- Weekly Sales Pattern -->
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-calendar-week me-2"></i>Mẫu bán hàng theo thứ</h5>
                            <small class="text-muted">Tuần này</small>
                        </div>
                        <div class="card-body">
                            <canvas id="weeklySalesChart" height="150"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Top Performing Days -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-trophy me-2"></i>Top 10 Ngày bán chạy nhất</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>#</th>
                                    <th>Ngày</th>
                                    <th>Số đơn hàng</th>
                                    <th>Doanh thu</th>
                                    <th>Giá trị đơn TB</th>
                                </tr>
                            </thead>
                            <tbody>
                                {{#each topDays}}
                                <tr>
                                    <td><strong>{{add @index 1}}</strong></td>
                                    <td>
                                        <strong>{{formatDate this._id}}</strong>
                                        {{#if (eq @index 0)}}
                                            <span class="badge bg-warning ms-1">Best</span>
                                        {{/if}}
                                    </td>
                                    <td>
                                        <span class="badge bg-primary">{{this.orders}} đơn</span>
                                    </td>
                                    <td>
                                        <strong class="text-success">{{formatCurrency this.revenue}}</strong>
                                    </td>
                                    <td>
                                        <span class="text-info">{{formatCurrency (divide this.revenue this.orders)}}</span>
                                    </td>
                                </tr>
                                {{/each}}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Customer Analysis & Payment Methods -->
            <div class="row mb-4">
                <!-- Customer Analysis -->
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-users me-2"></i>Phân tích khách hàng</h5>
                        </div>
                        <div class="card-body">
                            <div class="row text-center">
                                <div class="col-6">
                                    <h4 class="text-primary">{{customerAnalysis.totalCustomers}}</h4>
                                    <p class="mb-2">Tổng khách hàng</p>
                                </div>
                                <div class="col-6">
                                    <h4 class="text-success">{{customerAnalysis.newCustomers}}</h4>
                                    <p class="mb-2">Khách hàng mới</p>
                                </div>
                                <div class="col-6">
                                    <h4 class="text-info">{{customerAnalysis.returningCustomers}}</h4>
                                    <p class="mb-2">Khách quay lại</p>
                                </div>
                                <div class="col-6">
                                    <h4 class="text-warning">{{formatCurrency customerAnalysis.avgCustomerValue}}</h4>
                                    <p class="mb-2">Giá trị TB/khách</p>
                                </div>
                            </div>
                            <div class="mt-3">
                                <div class="progress mb-2">
                                    <div class="progress-bar bg-success" role="progressbar" 
                                         style="width: {{multiply (divide customerAnalysis.returningCustomers customerAnalysis.totalCustomers) 100}}%">
                                        {{multiply (divide customerAnalysis.returningCustomers customerAnalysis.totalCustomers) 100}}% Khách quay lại
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Payment Methods -->
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-credit-card me-2"></i>Phương thức thanh toán</h5>
                        </div>
                        <div class="card-body">
                            {{#each salesByPaymentMethod}}
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <div>
                                    <strong>{{this._id}}</strong>
                                    <br><small class="text-muted">{{this.orders}} đơn hàng</small>
                                </div>
                                <div class="text-end">
                                    <strong class="text-success">{{formatCurrency this.revenue}}</strong>
                                    <br><small class="text-muted">{{formatCurrency (divide this.revenue this.orders)}}/đơn</small>
                                </div>
                            </div>
                            {{#unless @last}}<hr>{{/unless}}
                            {{/each}}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Revenue by Category Table -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Doanh thu theo danh mục sản phẩm</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Danh mục</th>
                                    <th>Doanh thu</th>
                                    <th>Số lượng bán</th>
                                    <th>Số đơn hàng</th>
                                    <th>Giá TB/món</th>
                                    <th>% Tổng doanh thu</th>
                                </tr>
                            </thead>
                            <tbody>
                                {{#each revenueByCategory}}
                                <tr>
                                    <td><strong>{{this._id}}</strong></td>
                                    <td><strong class="text-success">{{formatCurrency this.revenue}}</strong></td>
                                    <td><span class="badge bg-primary">{{this.quantity}}</span></td>
                                    <td><span class="text-info">{{this.orders}}</span></td>
                                    <td><span class="text-muted">{{formatCurrency (divide this.revenue this.quantity)}}</span></td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="progress me-2" style="width: 80px; height: 20px;">
                                                <div class="progress-bar bg-success" role="progressbar" 
                                                     style="width: {{multiply (divideFloat this.revenue this.totalRevenue) 100}}%">
                                                </div>
                                            </div>
                                            <small class="text-muted">
                                                {{round (multiply (divideFloat this.revenue this.totalRevenue) 100) 0}}%
                                            </small>
                                        </div>
                                    </td>
                                </tr>
                                {{else}}
                                <tr>
                                    <td colspan="6" class="text-center text-muted">Không có dữ liệu</td>
                                </tr>
                                {{/each}}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
// Daily Sales Chart - Improved version with complete date range
const dailySalesData = {{{json dailySales}}};
const startDate = new Date('{{{dateRange.startDate}}}');
const endDate = new Date('{{{dateRange.endDate}}}');

// Calculate the number of days in the range
const daysDiff = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;

console.log('📊 Date range:', startDate, 'to', endDate, '- Days:', daysDiff);

let chartLabels = [];
let chartRevenues = [];
let chartOrderCounts = [];

if (daysDiff <= 20) {
    // Show daily data if <= 20 days
    console.log('📊 Using daily view');
    
    // Create complete date range (including days with 0 revenue)
    for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
        const dateStr = d.toISOString().split('T')[0]; // YYYY-MM-DD format
        const label = `${d.getDate().toString().padStart(2, '0')}/${(d.getMonth() + 1).toString().padStart(2, '0')}`;
        
        // Find data for this date
        const dayData = dailySalesData.find(item => item._id === dateStr);
        
        chartLabels.push(label);
        chartRevenues.push(dayData ? dayData.revenue : 0);
        chartOrderCounts.push(dayData ? dayData.orderCount : 0);
    }
} else {
    // Group by weeks if > 20 days
    console.log('📊 Using weekly view (too many days)');
    
    // Group data by week
    const weeklyData = {};
    dailySalesData.forEach(item => {
        const date = new Date(item._id);
        const weekStart = new Date(date);
        weekStart.setDate(date.getDate() - date.getDay() + 1); // Monday of the week
        const weekKey = weekStart.toISOString().split('T')[0];
        
        if (!weeklyData[weekKey]) {
            weeklyData[weekKey] = { revenue: 0, orderCount: 0 };
        }
        weeklyData[weekKey].revenue += item.revenue;
        weeklyData[weekKey].orderCount += item.orderCount;
    });
    
    // Convert to arrays
    Object.keys(weeklyData).sort().forEach(weekKey => {
        const weekStart = new Date(weekKey);
        const weekEnd = new Date(weekStart);
        weekEnd.setDate(weekStart.getDate() + 6);
        
        const label = `${weekStart.getDate().toString().padStart(2, '0')}/${(weekStart.getMonth() + 1).toString().padStart(2, '0')} - ${weekEnd.getDate().toString().padStart(2, '0')}/${(weekEnd.getMonth() + 1).toString().padStart(2, '0')}`;
        
        chartLabels.push(label);
        chartRevenues.push(weeklyData[weekKey].revenue);
        chartOrderCounts.push(weeklyData[weekKey].orderCount);
    });
}

console.log('📊 Chart data:', { labels: chartLabels, revenues: chartRevenues, orders: chartOrderCounts });

const dailyCtx = document.getElementById('dailySalesChart').getContext('2d');
new Chart(dailyCtx, {
    type: 'bar',
    data: {
        labels: chartLabels,
        datasets: [{
            label: daysDiff <= 20 ? 'Doanh thu hàng ngày (VND)' : 'Doanh thu hàng tuần (VND)',
            data: chartRevenues,
            backgroundColor: 'rgba(54, 162, 235, 0.8)',
            borderColor: 'rgba(54, 162, 235, 1)',
            borderWidth: 1,
            borderRadius: 4,
            borderSkipped: false,
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: true,
                position: 'top'
            },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        const revenue = new Intl.NumberFormat('vi-VN', { 
                            style: 'currency', 
                            currency: 'VND' 
                        }).format(context.parsed.y);
                        const orders = chartOrderCounts[context.dataIndex];
                        const period = daysDiff <= 20 ? 'ngày' : 'tuần';
                        return [
                            `Doanh thu ${period}: ${revenue}`,
                            `Số đơn hàng: ${orders}`
                        ];
                    }
                }
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    callback: function(value) {
                        return new Intl.NumberFormat('vi-VN', { 
                            style: 'currency', 
                            currency: 'VND',
                            notation: 'compact'
                        }).format(value);
                    }
                },
                grid: {
                    color: 'rgba(0, 0, 0, 0.1)'
                }
            },
            x: {
                grid: {
                    display: false
                },
                ticks: {
                    maxRotation: daysDiff > 15 ? 45 : 0, // Rotate labels if too many
                    font: {
                        size: daysDiff > 15 ? 10 : 12 // Smaller font if many labels
                    }
                }
            }
        }
    }
});

// Category Revenue Chart
const categoryData = {{{json revenueByCategory}}};
const categoryLabels = categoryData.map(item => item._id);
const categoryRevenues = categoryData.map(item => item.revenue);

const categoryCtx = document.getElementById('categoryRevenueChart').getContext('2d');
new Chart(categoryCtx, {
    type: 'doughnut',
    data: {
        labels: categoryLabels,
        datasets: [{
            data: categoryRevenues,
            backgroundColor: [
                '#FF6384',
                '#36A2EB',
                '#FFCE56',
                '#4BC0C0',
                '#9966FF',
                '#FF9F40'
            ]
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom'
            }
        }
    }
});

// Hourly Sales Chart
const hourlyData = {{{json hourlySales}}};
console.log('📊 Hourly data from backend:', hourlyData);
const hourLabels = Array.from({length: 24}, (_, i) => i + 'h');
const hourlyOrderCounts = hourLabels.map(hour => {
    const hourNum = parseInt(hour);
    const found = hourlyData.find(item => item._id === hourNum);
    return found ? found.orders : 0;
});
console.log('📊 Hourly order counts:', hourlyOrderCounts);

const hourlyCtx = document.getElementById('hourlySalesChart').getContext('2d');
new Chart(hourlyCtx, {
    type: 'bar',
    data: {
        labels: hourLabels,
        datasets: [{
            label: 'Số đơn hàng',
            data: hourlyOrderCounts,
            backgroundColor: 'rgba(54, 162, 235, 0.5)',
            borderColor: 'rgba(54, 162, 235, 1)',
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    stepSize: 1,
                    callback: function(value) {
                        if (Number.isInteger(value)) {
                            return value;
                        }
                    }
                }
            }
        }
    }
});

// Weekly Sales Chart
const weeklyData = {{{json weeklySales}}};
console.log('📊 Weekly data from backend:', weeklyData);
const weekLabels = ['Thứ 2', 'Thứ 3', 'Thứ 4', 'Thứ 5', 'Thứ 6', 'Thứ 7', 'Chủ nhật'];
const weeklyOrderCounts = [2,3,4,5,6,7,7].map((day, index) => {
    // Monday=2, Tuesday=3, Wednesday=4, Thursday=5, Friday=6, Saturday=7, Sunday=7
    const dayId = index === 6 ? 7 : day; // Last element (index 6) is Sunday with _id: 7
    const found = weeklyData.find(item => item._id === dayId);
    console.log(`📊 Day ${dayId} (${weekLabels[index]}): found =`, found);
    return found ? found.orders : 0;
});
console.log('📊 Weekly order counts:', weeklyOrderCounts);

const weeklyCtx = document.getElementById('weeklySalesChart').getContext('2d');
new Chart(weeklyCtx, {
    type: 'bar',
    data: {
        labels: weekLabels,
        datasets: [{
            label: 'Số đơn hàng',
            data: weeklyOrderCounts,
            backgroundColor: 'rgba(255, 206, 86, 0.5)',
            borderColor: 'rgba(255, 206, 86, 1)',
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    stepSize: 1,
                    callback: function(value) {
                        if (Number.isInteger(value)) {
                            return value;
                        }
                    }
                }
            }
        }
    }
});
</script>

{{#section 'styles'}}
<style>
.card {
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
}

.table th {
    border-top: none;
}

.progress {
    border-radius: 0.5rem;
}

.text-success {
    color: #28a745 !important;
}

.text-info {
    color: #17a2b8 !important;
}

.text-warning {
    color: #ffc107 !important;
}
</style>
{{/section}}
