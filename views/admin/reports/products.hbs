{{#section 'title'}}{{title}}{{/section}}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-box me-2"></i>{{title}}</h2>
                <div>
                    <div class="btn-group" role="group">
                        <a href="?{{#each filters}}{{@key}}={{this}}&{{/each}}exportFormat=json" class="btn btn-outline-primary">
                            <i class="fas fa-download me-1"></i>Export JSON
                        </a>
                        <a href="?{{#each filters}}{{@key}}={{this}}&{{/each}}exportFormat=csv" class="btn btn-outline-success">
                            <i class="fas fa-file-csv me-1"></i>Export CSV
                        </a>
                    </div>
                </div>
            </div>

            <!-- Filters -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-filter me-2"></i>Bộ lọc báo cáo</h5>
                </div>
                <div class="card-body">
                    <form method="GET" action="/admin/reports/products">
                        <div class="row">
                            <div class="col-md-3">
                                <label class="form-label">Từ ngày</label>
                                <input type="date" class="form-control" name="startDate" value="{{formatDateInput dateRange.startDate}}">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Đến ngày</label>
                                <input type="date" class="form-control" name="endDate" value="{{formatDateInput dateRange.endDate}}">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Danh mục</label>
                                <select class="form-select" name="category">
                                    <option value="">Tất cả</option>
                                    {{#each allCategories}}
                                        <option value="{{this}}" {{#if (eq ../filters.category this)}}selected{{/if}}>{{this}}</option>
                                    {{/each}}
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Trạng thái</label>
                                <select class="form-select" name="status">
                                    <option value="">Tất cả</option>
                                    <option value="available" {{#if (eq filters.status 'available')}}selected{{/if}}>Có sẵn</option>
                                    <option value="unavailable" {{#if (eq filters.status 'unavailable')}}selected{{/if}}>Hết hàng</option>
                                </select>
                            </div>
                            <div class="col-md-2 d-flex align-items-end">
                                <button type="submit" class="btn btn-primary me-2">
                                    <i class="fas fa-sync me-1"></i>Cập nhật
                                </button>
                                <a href="/admin/reports/products" class="btn btn-outline-secondary">
                                    <i class="fas fa-undo"></i>
                                </a>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Statistics Cards -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card bg-primary text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4>{{statistics.totalProducts}}</h4>
                                    <p class="mb-0">Tổng sản phẩm</p>
                                    <small>Trong hệ thống</small>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-box fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-success text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4>{{statistics.availableProducts}}</h4>
                                    <p class="mb-0">Sản phẩm có sẵn</p>
                                    <small>Đang bán</small>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-check-circle fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-warning text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4>{{statistics.unavailableProducts}}</h4>
                                    <p class="mb-0">Hết hàng</p>
                                    <small>Cần bổ sung</small>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-exclamation-triangle fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-info text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4>{{formatCurrency statistics.avgPrice}}</h4>
                                    <p class="mb-0">Giá trung bình</p>
                                    <small>Của sản phẩm</small>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-tag fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts Row -->
            <div class="row mb-4">
                <!-- Product Trends Chart -->
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>Xu hướng bán hàng theo ngày</h5>
                        </div>
                        <div class="card-body">
                            <canvas id="productTrendsChart" height="100"></canvas>
                        </div>
                    </div>
                </div>
                
                <!-- Category Performance Chart -->
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-chart-pie me-2"></i>Hiệu suất danh mục</h5>
                        </div>
                        <div class="card-body">
                            <canvas id="categoryChart" height="200"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Best Selling Products Table -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-star me-2"></i>Top 20 Sản phẩm bán chạy nhất</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>#</th>
                                    <th>Sản phẩm</th>
                                    <th>Danh mục</th>
                                    <th>Đã bán</th>
                                    <th>Doanh thu</th>
                                    <th>Số đơn</th>
                                    <th>Giá TB</th>
                                </tr>
                            </thead>
                            <tbody>
                                {{#each bestSellingProducts}}
                                <tr>
                                    <td><strong>{{add @index 1}}</strong></td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            {{#if this.productImage}}
                                                <img src="{{this.productImage}}" alt="{{this.productName}}" 
                                                     class="rounded me-2" style="width: 40px; height: 40px; object-fit: cover;">
                                            {{/if}}
                                            <div>
                                                <strong>{{this.productName}}</strong>
                                                {{#if (gt this.totalQuantity 100)}}
                                                    <span class="badge bg-warning ms-1">Hot</span>
                                                {{/if}}
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="badge bg-secondary">{{this.productCategory}}</span>
                                    </td>
                                    <td>
                                        <span class="badge bg-primary">{{this.totalQuantity}} món</span>
                                    </td>
                                    <td>
                                        <strong class="text-success">{{formatCurrency this.totalRevenue}}</strong>
                                    </td>
                                    <td>
                                        <span class="text-info">{{this.orderCount}} đơn</span>
                                    </td>
                                    <td>
                                        <span class="text-muted">{{formatCurrency this.avgPrice}}</span>
                                    </td>
                                </tr>
                                {{/each}}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Category Performance & Low Stock -->
            <div class="row mb-4">
                <!-- Category Performance -->
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Hiệu suất theo danh mục</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>Danh mục</th>
                                            <th>Số lượng bán</th>
                                            <th>Doanh thu</th>
                                            <th>Số sản phẩm</th>
                                            <th>Giá TB</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {{#each categoryPerformance}}
                                        <tr>
                                            <td><strong>{{this.category}}</strong></td>
                                            <td><span class="badge bg-primary">{{this.totalQuantity}}</span></td>
                                            <td><strong class="text-success">{{formatCurrency this.totalRevenue}}</strong></td>
                                            <td><span class="text-info">{{this.uniqueProductCount}}</span></td>
                                            <td><span class="text-muted">{{formatCurrency this.avgPrice}}</span></td>
                                        </tr>
                                        {{/each}}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Low Stock Products -->
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0 text-warning"><i class="fas fa-exclamation-triangle me-2"></i>Sản phẩm sắp hết</h5>
                        </div>
                        <div class="card-body">
                            {{#if lowStockProducts}}
                                {{#each lowStockProducts}}
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <div>
                                        <strong>{{this.name}}</strong>
                                        <br><small class="text-muted">{{this.category}}</small>
                                    </div>
                                    <div class="text-end">
                                        <span class="badge {{#if (lt this.stock 5)}}bg-danger{{else}}bg-warning{{/if}}">
                                            {{this.stock}} còn lại
                                        </span>
                                    </div>
                                </div>
                                {{#unless @last}}<hr>{{/unless}}
                                {{/each}}
                            {{else}}
                                <div class="text-center text-muted">
                                    <i class="fas fa-check-circle fa-3x mb-3"></i>
                                    <p>Tất cả sản phẩm đều có đủ hàng!</p>
                                </div>
                            {{/if}}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Price Analysis -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-calculator me-2"></i>Phân tích giá theo danh mục</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead class="table-dark">
                                <tr>
                                    <th>Danh mục</th>
                                    <th>Số sản phẩm</th>
                                    <th>Giá thấp nhất</th>
                                    <th>Giá cao nhất</th>
                                    <th>Giá trung bình</th>
                                    <th>Khoảng giá</th>
                                </tr>
                            </thead>
                            <tbody>
                                {{#each priceAnalysis}}
                                <tr>
                                    <td><strong>{{this._id}}</strong></td>
                                    <td><span class="badge bg-info">{{this.productCount}}</span></td>
                                    <td><span class="text-success">{{formatCurrency this.minPrice}}</span></td>
                                    <td><span class="text-danger">{{formatCurrency this.maxPrice}}</span></td>
                                    <td><strong>{{formatCurrency this.avgPrice}}</strong></td>
                                    <td>
                                        <div class="progress" style="height: 20px;">
                                            <div class="progress-bar bg-gradient" role="progressbar" style="width: 100%">
                                                {{formatCurrency (subtract this.maxPrice this.minPrice)}}
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                {{/each}}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Recent Products -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-plus-circle me-2"></i>Sản phẩm mới thêm gần đây</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        {{#each recentProducts}}
                        <div class="col-md-6 col-lg-4 mb-3">
                            <div class="card h-100">
                                {{#if this.image}}
                                    <img src="{{this.image}}" class="card-img-top" alt="{{this.name}}" style="height: 150px; object-fit: cover;">
                                {{/if}}
                                <div class="card-body">
                                    <h6 class="card-title">{{this.name}}</h6>
                                    <p class="card-text">
                                        <span class="badge bg-secondary">{{this.category}}</span>
                                        <br><strong class="text-success">{{formatCurrency this.price}}</strong>
                                        <br><small class="text-muted">Thêm: {{formatDate this.createdAt}}</small>
                                    </p>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="badge {{#if this.isAvailable}}bg-success{{else}}bg-danger{{/if}}">
                                            {{#if this.isAvailable}}Có sẵn{{else}}Hết hàng{{/if}}
                                        </span>
                                        <small class="text-muted">Stock: {{this.stock}}</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {{/each}}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
// Product Trends Chart
const productTrendsData = {{{json productTrends}}};
const trendLabels = productTrendsData.map(item => item.date);
const quantityData = productTrendsData.map(item => item.totalQuantity);
const revenueData = productTrendsData.map(item => item.totalRevenue);

const trendsCtx = document.getElementById('productTrendsChart').getContext('2d');
new Chart(trendsCtx, {
    type: 'line',
    data: {
        labels: trendLabels,
        datasets: [{
            label: 'Số lượng bán',
            data: quantityData,
            borderColor: 'rgb(75, 192, 192)',
            backgroundColor: 'rgba(75, 192, 192, 0.2)',
            yAxisID: 'y'
        }, {
            label: 'Doanh thu (VND)',
            data: revenueData,
            borderColor: 'rgb(255, 99, 132)',
            backgroundColor: 'rgba(255, 99, 132, 0.2)',
            yAxisID: 'y1'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: {
                type: 'linear',
                display: true,
                position: 'left',
                beginAtZero: true
            },
            y1: {
                type: 'linear',
                display: true,
                position: 'right',
                beginAtZero: true,
                grid: {
                    drawOnChartArea: false,
                }
            }
        }
    }
});

// Category Performance Chart
const categoryData = {{{json categoryPerformance}}};
const categoryLabels = categoryData.map(item => item.category);
const categoryRevenue = categoryData.map(item => item.totalRevenue);

const categoryCtx = document.getElementById('categoryChart').getContext('2d');
new Chart(categoryCtx, {
    type: 'doughnut',
    data: {
        labels: categoryLabels,
        datasets: [{
            data: categoryRevenue,
            backgroundColor: [
                '#FF6384',
                '#36A2EB',
                '#FFCE56',
                '#4BC0C0',
                '#9966FF',
                '#FF9F40',
                '#FF6384',
                '#C9CBCF'
            ]
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom'
            }
        }
    }
});
</script>

{{#section 'styles'}}
<style>
.card {
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
}

.table th {
    border-top: none;
}

.progress {
    border-radius: 0.5rem;
}

.card-img-top {
    border-radius: 0.375rem 0.375rem 0 0;
}
</style>
{{/section}}
