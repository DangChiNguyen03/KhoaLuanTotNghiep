{{#section 'title'}}{{title}}{{/section}}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-chart-bar me-2"></i>{{title}}</h2>
                <div>
                    <div class="btn-group" role="group">
                        <a href="?{{#each filters}}{{@key}}={{this}}&{{/each}}exportFormat=json" class="btn btn-outline-primary">
                            <i class="fas fa-download me-1"></i>Export JSON
                        </a>
                        <a href="?{{#each filters}}{{@key}}={{this}}&{{/each}}exportFormat=csv" class="btn btn-outline-success">
                            <i class="fas fa-file-csv me-1"></i>Export CSV
                        </a>
                    </div>
                </div>
            </div>

            <!-- Date Range Filter -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-calendar me-2"></i>Khoảng thời gian báo cáo</h5>
                </div>
                <div class="card-body">
                    <form method="GET" action="/admin/reports/customers">
                        <div class="row">
                            <div class="col-md-4">
                                <label class="form-label">Từ ngày</label>
                                <input type="date" class="form-control" name="startDate" value="{{formatDateInput dateRange.startDate}}">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Đến ngày</label>
                                <input type="date" class="form-control" name="endDate" value="{{formatDateInput dateRange.endDate}}">
                            </div>
                            <div class="col-md-4 d-flex align-items-end">
                                <button type="submit" class="btn btn-primary me-2">
                                    <i class="fas fa-sync me-1"></i>Cập nhật báo cáo
                                </button>
                                <a href="/admin/reports/customers" class="btn btn-outline-secondary">
                                    <i class="fas fa-undo me-1"></i>Reset
                                </a>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Statistics Cards -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card bg-primary text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4>{{statistics.totalCustomers}}</h4>
                                    <p class="mb-0">Tổng khách hàng</p>
                                    <small>Trong khoảng thời gian</small>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-users fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-success text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4>{{statistics.activeCustomers}}</h4>
                                    <p class="mb-0">Khách hoạt động</p>
                                    <small>Đã từng đăng nhập</small>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-user-check fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-info text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4>{{#if statistics.avgAge}}{{statistics.avgAge}}{{else}}N/A{{/if}}</h4>
                                    <p class="mb-0">Tuổi trung bình</p>
                                    <small>Của khách hàng</small>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-birthday-cake fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-warning text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4>{{#if retention.returningCustomers}}{{retention.returningCustomers}}{{else}}0{{/if}}</h4>
                                    <p class="mb-0">Khách quay lại</p>
                                    <small>Đặt hàng > 1 lần</small>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-redo fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts Row -->
            <div class="row mb-4">
                <!-- Registration Trend Chart -->
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>Xu hướng đăng ký</h5>
                            <small class="text-muted">{{formatDate dateRange.startDate}} - {{formatDate dateRange.endDate}}</small>
                        </div>
                        <div class="card-body">
                            <div class="chart-container" style="height: 300px; position: relative;">
                                <canvas id="registrationChart" style="height: 300px !important; max-height: 300px !important;"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Demographics Chart -->
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-chart-pie me-2"></i>Phân bố độ tuổi</h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container" style="height: 280px; position: relative;">
                                <canvas id="demographicsChart" style="height: 280px !important; max-height: 280px !important;"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Top Customers Table -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-crown me-2"></i>Top 20 Khách hàng VIP</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>#</th>
                                    <th>Tên khách hàng</th>
                                    <th>Email</th>
                                    <th>Tuổi</th>
                                    <th>Số đơn hàng</th>
                                    <th>Tổng chi tiêu</th>
                                    <th>Giá trị TB/đơn</th>
                                    <th>Đơn hàng cuối</th>
                                </tr>
                            </thead>
                            <tbody>
                                {{#each topCustomers}}
                                <tr>
                                    <td><strong>{{add @index 1}}</strong></td>
                                    <td>
                                        <div>
                                            <strong>{{this.customerName}}</strong>
                                            {{#if (gt this.totalSpent 1000000)}}
                                                <span class="badge bg-warning ms-1">VIP</span>
                                            {{/if}}
                                        </div>
                                    </td>
                                    <td>
                                        <div>
                                            <small>{{this.customerEmail}}</small>
                                            {{#if this.customerPhone}}
                                                <br><small><i class="fas fa-phone me-1"></i>{{this.customerPhone}}</small>
                                            {{/if}}
                                        </div>
                                    </td>
                                    <td>
                                        {{#if this.customerBirthday}}
                                            {{calculateAge this.customerBirthday}}
                                        {{else}}
                                            <span class="text-muted">Chưa cập nhật</span>
                                        {{/if}}
                                    </td>
                                    <td>
                                        <span class="badge bg-primary">{{this.totalOrders}} đơn</span>
                                    </td>
                                    <td>
                                        <strong class="text-success">{{formatCurrency this.totalSpent}}</strong>
                                    </td>
                                    <td>
                                        <span class="text-info">{{formatCurrency this.avgOrderValue}}</span>
                                    </td>
                                    <td>
                                        <small>{{formatDate this.lastOrderDate}}</small>
                                    </td>
                                </tr>
                                {{/each}}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Retention Analysis -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-chart-area me-2"></i>Phân tích độ trung thành khách hàng</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="text-center">
                                <h3 class="text-primary">{{retention.totalCustomers}}</h3>
                                <p class="mb-0">Tổng khách hàng có đơn hàng</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-center">
                                <h3 class="text-success">{{retention.returningCustomers}}</h3>
                                <p class="mb-0">Khách hàng quay lại</p>
                                <small class="text-muted">{{#if retention.totalCustomers}}({{truncate retention.returningRate 4}}%){{/if}}</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-center">
                                <h3 class="text-info">{{#if retention.avgDaysBetweenOrders}}{{retention.avgDaysBetweenOrders}}{{else}}0{{/if}}</h3>
                                <p class="mb-0">Số ngày TB giữa các đơn</p>
                                <small class="text-muted">Của khách quay lại</small>
                            </div>
                        </div>
                    </div>
                    
                    {{#if (gt retention.totalCustomers 0)}}
                    <div class="mt-4">
                        <div class="progress" style="height: 30px;">
                            <div class="progress-bar bg-success" role="progressbar" style="width: {{retention.returningRate}}%">
                                Khách quay lại: {{truncate retention.returningRate 4}}%
                            </div>
                            <div class="progress-bar bg-warning" role="progressbar" style="width: {{retention.newCustomersRate}}%">
                                Khách mới: {{truncate retention.newCustomersRate 4}}%
                            </div>
                        </div>
                    </div>
                    {{/if}}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
// Smart Registration Trend Chart
const registrationData = {{{json registrationTrend}}};
const startDate = new Date('{{{dateRange.startDate}}}');
const endDate = new Date('{{{dateRange.endDate}}}');
const daysDiff = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;

let chartLabels = [];
let chartValues = [];
let groupingUnit = 'ngày';

if (daysDiff <= 30) {
    // Daily view
    groupingUnit = 'ngày';
    registrationData.forEach(item => {
        const date = new Date(item._id);
        chartLabels.push(`${date.getDate().toString().padStart(2, '0')}/${(date.getMonth() + 1).toString().padStart(2, '0')}`);
        chartValues.push(item.count);
    });
} else if (daysDiff <= 90) {
    // Weekly view
    groupingUnit = 'tuần';
    const weeklyData = {};
    registrationData.forEach(item => {
        const date = new Date(item._id);
        const weekStart = new Date(date);
        weekStart.setDate(date.getDate() - (date.getDay() === 0 ? 6 : date.getDay() - 1));
        const weekKey = weekStart.toISOString().split('T')[0];
        if (!weeklyData[weekKey]) weeklyData[weekKey] = 0;
        weeklyData[weekKey] += item.count;
    });
    Object.keys(weeklyData).sort().forEach(weekKey => {
        const weekStart = new Date(weekKey);
        const weekEnd = new Date(weekStart);
        weekEnd.setDate(weekStart.getDate() + 6);
        chartLabels.push(`${weekStart.getDate().toString().padStart(2, '0')}/${(weekStart.getMonth() + 1).toString().padStart(2, '0')}`);
        chartValues.push(weeklyData[weekKey]);
    });
} else {
    // Monthly view
    groupingUnit = 'tháng';
    const monthlyData = {};
    registrationData.forEach(item => {
        const date = new Date(item._id);
        const monthKey = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
        if (!monthlyData[monthKey]) monthlyData[monthKey] = 0;
        monthlyData[monthKey] += item.count;
    });
    Object.keys(monthlyData).sort().forEach(monthKey => {
        const [year, month] = monthKey.split('-');
        chartLabels.push(`Thg ${month}/${year.slice(2)}`);
        chartValues.push(monthlyData[monthKey]);
    });
}

const registrationCanvas = document.getElementById('registrationChart');
registrationCanvas.height = 300;
registrationCanvas.style.height = '300px';
const registrationCtx = registrationCanvas.getContext('2d');
new Chart(registrationCtx, {
    type: 'bar',
    data: {
        labels: chartLabels,
        datasets: [{
            label: `Số khách hàng đăng ký theo ${groupingUnit}`,
            data: chartValues,
            backgroundColor: 'rgba(75, 192, 192, 0.8)',
            borderColor: 'rgba(75, 192, 192, 1)',
            borderWidth: 1,
            borderRadius: 4,
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        aspectRatio: 2,
        plugins: {
            tooltip: {
                callbacks: {
                    label: function(context) {
                        return `Số đăng ký: ${context.parsed.y}`;
                    }
                }
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: { stepSize: 1 }
            },
            x: {
                grid: { display: false }
            }
        }
    }
});

if (chartValues.every(v => v === 0)) {
    const note = document.createElement('div');
    note.className = 'text-center text-muted mt-2';
    note.innerText = 'Không có đăng ký mới trong khoảng thời gian này';
    registrationCanvas.parentElement.appendChild(note);
}

// Demographics Chart
const demographicsData = {{{json demographics}}};
const ageGroups = demographicsData.map(item => item._id.ageGroup);
const ageCounts = demographicsData.map(item => item.count);

const demographicsCanvas = document.getElementById('demographicsChart');
if (demographicsData.length === 0) {
    const container = demographicsCanvas.parentElement;
    demographicsCanvas.remove();
    const empty = document.createElement('div');
    empty.className = 'text-center text-muted py-5';
    empty.innerText = 'Chưa có dữ liệu độ tuổi trong khoảng thời gian này';
    container.appendChild(empty);
} else {
    demographicsCanvas.height = 280;
    demographicsCanvas.style.height = '280px';
    demographicsCanvas.width = demographicsCanvas.parentElement.clientWidth;
    const demographicsCtx = demographicsCanvas.getContext('2d');
    new Chart(demographicsCtx, {
        type: 'doughnut',
        data: {
            labels: ageGroups,
            datasets: [{
                data: ageCounts,
                backgroundColor: [
                    '#FF6384',
                    '#36A2EB',
                    '#FFCE56',
                    '#4BC0C0',
                    '#9966FF',
                    '#FF9F40'
                ]
            }]
        },
        options: {
            responsive: false,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}
</script>

{{#section 'styles'}}
<style>
.chart-container {
    position: relative;
    width: 100%;
    height: 300px !important;
    max-height: 300px !important;
    min-height: 300px !important;
    overflow: hidden;
}

.chart-container > canvas {
    width: 100% !important;
    height: 300px !important;
    max-height: 300px !important;
    display: block;
}

#registrationChart {
    height: 300px !important;
    max-height: 300px !important;
}

#demographicsChart {
    height: 280px !important;
    max-height: 280px !important;
}
.card {
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    border: 1px solid rgba(0, 0, 0, 0.125);
}

.card-body {
    padding: 1rem;
    overflow: hidden;
}

.row.mb-4 .col-md-6 {
    height: auto;
}

.row.mb-4 .card {
    height: auto;
    max-height: 400px;
}

.progress {
    border-radius: 0.5rem;
}

.table th {
    border-top: none;
}

.badge {
    font-size: 0.75em;
}
</style>
{{/section}}
