{{#section 'title'}}Qu·∫£n l√Ω ƒë∆°n h√†ng{{/section}}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-shopping-cart me-2"></i>Qu·∫£n l√Ω ƒë∆°n h√†ng</h2>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="/admin/dashboard">Dashboard</a></li>
                        <li class="breadcrumb-item active">ƒê∆°n h√†ng</li>
                    </ol>
                </nav>
            </div>

            {{> messages}}

            <!-- Th·ªëng k√™ tr·∫°ng th√°i -->
            <div class="row mb-4">
                <div class="col-md-4">
                    <div class="card bg-primary text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4 class="card-title">{{statusStats.all}}</h4>
                                    <p class="card-text">T·ªïng ƒë∆°n h√†ng</p>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-shopping-cart fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card bg-warning text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4 class="card-title">{{statusStats.pending}}</h4>
                                    <p class="card-text">ƒêang x·ª≠ l√Ω</p>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-clock fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card bg-success text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4 class="card-title">{{statusStats.completed}}</h4>
                                    <p class="card-text">Ho√†n th√†nh</p>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-check-circle fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- B·ªô l·ªçc -->
            <div class="card mb-4">
                <div class="card-body">
                    <form method="GET" action="/admin/orders" class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label">Tr·∫°ng th√°i</label>
                            <select class="form-select" name="status">
                                <option value="">T·∫•t c·∫£ tr·∫°ng th√°i</option>
                                <option value="completed" {{#if (eq status 'completed')}}selected{{/if}}>Ho√†n th√†nh</option>
                                <option value="cancelled" {{#if (eq status 'cancelled')}}selected{{/if}}>ƒê√£ h·ªßy</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Thanh to√°n</label>
                            <select class="form-select" name="paymentMethod">
                                <option value="">T·∫•t c·∫£ ph∆∞∆°ng th·ª©c</option>
                                <option value="cash" {{#if (eq paymentMethod 'cash')}}selected{{/if}}>üí∞ Ti·ªÅn m·∫∑t</option>
                                <option value="vnpay" {{#if (eq paymentMethod 'vnpay')}}selected{{/if}}>üí≥ VNPay</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">T√¨m ki·∫øm</label>
                            <input type="text" class="form-control" name="search" placeholder="T√¨m ki·∫øm theo m√£ ƒë∆°n, t√™n kh√°ch h√†ng..." value="{{search}}">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">&nbsp;</label>
                            <div class="d-grid">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-search"></i> L·ªçc
                                </button>
                            </div>
                        </div>
                    </form>
                    {{#if (or status search)}}
                    <div class="mt-2">
                        <a href="/admin/orders" class="btn btn-secondary btn-sm">
                            <i class="fas fa-times"></i> X√≥a b·ªô l·ªçc
                        </a>
                    </div>
                    {{/if}}
                </div>
            </div>

            <!-- Danh s√°ch ƒë∆°n h√†ng -->
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Danh s√°ch ƒë∆°n h√†ng</h5>
                </div>
                <div class="card-body">
                    {{#if orders.length}}
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>M√£ ƒë∆°n</th>
                                    <th>Kh√°ch h√†ng</th>
                                    <th>S·∫£n ph·∫©m</th>
                                    <th>T·ªïng ti·ªÅn</th>
                                    <th>Thanh to√°n</th>
                                    <th>Tr·∫°ng th√°i</th>
                                    <th>Ng√†y ƒë·∫∑t</th>
                                    <th>Thao t√°c</th>
                                </tr>
                            </thead>
                            <tbody>
                                {{#each orders}}
                                <tr>
                                    <td>
                                        <code>#{{substring this._id 0 8}}</code>
                                    </td>
                                    <td>
                                        <div>
                                            <strong>{{this.user.name}}</strong>
                                            <br>
                                            <small class="text-muted">{{this.user.email}}</small>
                                            {{#if this.user.phone}}
                                            <br>
                                            <small class="text-muted">{{this.user.phone}}</small>
                                            {{/if}}
                                        </div>
                                    </td>
                                    <td>
                                        <div class="order-items">
                                            {{#each this.items}}
                                            <div class="mb-2">
                                                <div class="d-flex align-items-center">
                                                    {{#if this.product.image}}
                                                    <img src="{{this.product.image}}" alt="{{this.product.name}}" class="me-2" style="width: 30px; height: 30px; object-fit: cover; border-radius: 4px;" onerror="this.style.display='none'; this.nextElementSibling.style.display='inline-flex';">
                                                    <div class="me-2 d-none" style="width: 30px; height: 30px; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; display: inline-flex; align-items: center; justify-content: center;">
                                                        <i class="fas fa-image text-muted" style="font-size: 12px;"></i>
                                                    </div>
                                                    {{else}}
                                                    <div class="me-2" style="width: 30px; height: 30px; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; display: inline-flex; align-items: center; justify-content: center;">
                                                        <i class="fas fa-image text-muted" style="font-size: 12px;"></i>
                                                    </div>
                                                    {{/if}}
                                                    <div>
                                                        <strong>{{this.product.name}}</strong>
                                                        {{#if this.size}} ({{this.size}}){{/if}}
                                                        <br>
                                                        <small class="text-muted">SL: {{this.quantity}}</small>
                                                        {{#if this.toppings.length}}
                                                        <br>
                                                        <small class="text-info">
                                                            {{#each this.toppings}}{{#if this.name}}{{this.name}}{{#unless @last}}, {{/unless}}{{/if}}{{/each}}
                                                        </small>
                                                        {{/if}}
                                                        {{#if this.sugarLevel}}
                                                        <br>
                                                        <small class="text-muted">ƒê∆∞·ªùng: {{this.sugarLevel}}</small>
                                                        {{/if}}
                                                        {{#if this.iceLevel}}
                                                        <small class="text-muted">| ƒê√°: {{this.iceLevel}}</small>
                                                        {{/if}}
                                                    </div>
                                                </div>
                                            </div>
                                            {{/each}}
                                        </div>
                                    </td>
                                    <td>
                                        <strong class="text-success">{{formatPrice this.totalPrice}}</strong>
                                    </td>
                                    <td>
                                        <span class="badge {{#if (eq this.paymentMethod 'cash')}}bg-success{{else if (eq this.paymentMethod 'vnpay')}}bg-primary{{else}}bg-info{{/if}}">
                                            {{#if (eq this.paymentMethod 'cash')}}üí∞ Ti·ªÅn m·∫∑t{{else if (eq this.paymentMethod 'vnpay')}}üí≥ VNPay{{else if (eq this.paymentMethod 'bank')}}üí≥ VNPay{{else if (eq this.paymentMethod 'momo')}}üì± MoMo{{else}}{{this.paymentMethod}}{{/if}}
                                        </span>
                                    </td>
                                    <td>
                                        <span class="badge 
                                            {{#if (eq this.status 'pending')}}bg-secondary
                                            {{else if (eq this.status 'confirmed')}}bg-info
                                            {{else if (eq this.status 'preparing')}}bg-warning
                                            {{else if (eq this.status 'ready')}}bg-primary
                                            {{else if (eq this.status 'completed')}}bg-success
                                            {{else if (eq this.status 'cancelled')}}bg-danger
                                            {{else}}bg-secondary{{/if}}">
                                            {{#if (eq this.status 'pending')}}Ch·ªù x√°c nh·∫≠n
                                            {{else if (eq this.status 'confirmed')}}ƒê√£ x√°c nh·∫≠n
                                            {{else if (eq this.status 'preparing')}}ƒêang chu·∫©n b·ªã
                                            {{else if (eq this.status 'ready')}}S·∫µn s√†ng
                                            {{else if (eq this.status 'completed')}}Ho√†n th√†nh
                                            {{else if (eq this.status 'cancelled')}}ƒê√£ h·ªßy
                                            {{else}}{{this.status}}{{/if}}
                                        </span>
                                    </td>
                                    <td>
                                        <small>{{formatDateTime this.createdAt}}</small>
                                    </td>
                                    <td>
                                        <div class="btn-group" role="group">
                                            {{#if (eq this.status 'pending')}}
                                            <button type="button" class="btn btn-sm btn-info" onclick="updateOrderStatus('{{this._id}}', 'confirmed')" title="X√°c nh·∫≠n ƒë∆°n h√†ng">
                                                <i class="fas fa-check-circle"></i>
                                            </button>
                                            {{else if (eq this.status 'confirmed')}}
                                            <button type="button" class="btn btn-sm btn-warning" onclick="updateOrderStatus('{{this._id}}', 'preparing')" title="B·∫Øt ƒë·∫ßu chu·∫©n b·ªã">
                                                <i class="fas fa-play"></i>
                                            </button>
                                            {{else if (eq this.status 'preparing')}}
                                            <button type="button" class="btn btn-sm btn-primary" onclick="updateOrderStatus('{{this._id}}', 'ready')" title="S·∫µn s√†ng giao h√†ng">
                                                <i class="fas fa-box"></i>
                                            </button>
                                            {{else if (eq this.status 'ready')}}
                                            <button type="button" class="btn btn-sm btn-success" onclick="updateOrderStatus('{{this._id}}', 'completed')" title="Ho√†n th√†nh ƒë∆°n h√†ng">
                                                <i class="fas fa-check"></i>
                                            </button>
                                            {{/if}}
                                            
                                            {{#unless (eq this.status 'cancelled')}}
                                             {{#unless (eq this.status 'completed')}}
                                             <button type="button" class="btn btn-sm btn-danger" onclick="updateOrderStatus('{{this._id}}', 'cancelled')" title="H·ªßy ƒë∆°n h√†ng">
                                                 <i class="fas fa-times"></i>
                                             </button>
                                             {{/unless}}
                                             {{/unless}}
                                             
                                             <!-- Print Invoice Button -->
                                             <a href="/orders/{{this._id}}/invoice" target="_blank" class="btn btn-sm btn-secondary" title="In h√≥a ƒë∆°n">
                                                 <i class="fas fa-print"></i>
                                             </a>
                                        </div>
                                    </td>
                                </tr>
                                {{/each}}
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td colspan="8">
                                        <div class="d-flex justify-content-between">
                                            <div>
                                                <small>T·ªïng s·ªë ƒë∆°n h√†ng: {{statusStats.all}}</small>
                                            </div>
                                            <div>
                                                <small>T·ªïng doanh thu (ƒë√£ ho√†n th√†nh): {{formatPrice totalRevenue}}</small>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>

                    <!-- Pagination -->
                    {{#if (gt totalPages 1)}}
                    <nav aria-label="Order pagination">
                        <ul class="pagination justify-content-center">
                            {{#if (gt currentPage 1)}}
                            <li class="page-item">
                                <a class="page-link" href="/admin/orders?page={{subtract currentPage 1}}{{#if status}}&status={{status}}{{/if}}{{#if search}}&search={{search}}{{/if}}">Tr∆∞·ªõc</a>
                            </li>
                            {{/if}}
                            
                            {{#each (range 1 totalPages)}}
                            <li class="page-item {{#if (eq this ../currentPage)}}active{{/if}}">
                                <a class="page-link" href="/admin/orders?page={{this}}{{#if ../status}}&status={{../status}}{{/if}}{{#if ../search}}&search={{../search}}{{/if}}">{{this}}</a>
                            </li>
                            {{/each}}
                            
                            {{#if (lt currentPage totalPages)}}
                            <li class="page-item">
                                <a class="page-link" href="/admin/orders?page={{add currentPage 1}}{{#if status}}&status={{status}}{{/if}}{{#if search}}&search={{search}}{{/if}}">Sau</a>
                            </li>
                            {{/if}}
                        </ul>
                    </nav>
                    {{/if}}

                    {{else}}
                    <div class="text-center py-5">
                        <i class="fas fa-shopping-cart fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">
                            {{#if (or status search)}}
                            Kh√¥ng t√¨m th·∫•y ƒë∆°n h√†ng n√†o
                            {{else}}
                            Ch∆∞a c√≥ ƒë∆°n h√†ng n√†o
                            {{/if}}
                        </h5>
                        {{#if (or status search)}}
                        <a href="/admin/orders" class="btn btn-primary">Xem t·∫•t c·∫£ ƒë∆°n h√†ng</a>
                        {{/if}}
                    </div>
                    {{/if}}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal chi ti·∫øt ƒë∆°n h√†ng -->
<div class="modal fade" id="orderDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Chi ti·∫øt ƒë∆°n h√†ng</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="orderDetailContent">
                <!-- N·ªôi dung s·∫Ω ƒë∆∞·ª£c load b·∫±ng JavaScript -->
            </div>
        </div>
    </div>
</div>

<style>
.order-items {
    max-height: 200px;
    overflow-y: auto;
}
.order-items::-webkit-scrollbar {
    width: 4px;
}
.order-items::-webkit-scrollbar-track {
    background: #f1f1f1;
}
.order-items::-webkit-scrollbar-thumb {
    background: #888;
    border-radius: 2px;
}
</style>

<script>
function updateOrderStatus(orderId, status) {
    const statusMessages = {
        'confirmed': 'x√°c nh·∫≠n ƒë∆°n h√†ng',
        'preparing': 'b·∫Øt ƒë·∫ßu chu·∫©n b·ªã ƒë∆°n h√†ng',
        'ready': 'ƒë√°nh d·∫•u ƒë∆°n h√†ng s·∫µn s√†ng',
        'completed': 'ho√†n th√†nh ƒë∆°n h√†ng',
        'cancelled': 'h·ªßy ƒë∆°n h√†ng',
        'pending': 'chuy·ªÉn v·ªÅ tr·∫°ng th√°i ch·ªù x·ª≠ l√Ω'
    };
    
    const statusText = statusMessages[status] || status;
    
    if (confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ${statusText}?`)) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/admin/orders/${orderId}/status`;
        
        const statusInput = document.createElement('input');
        statusInput.type = 'hidden';
        statusInput.name = 'status';
        statusInput.value = status;
        
        form.appendChild(statusInput);
        document.body.appendChild(form);
        form.submit();
    }
}

function viewOrderDetail(orderId) {
    // T·∫°m th·ªùi hi·ªÉn th·ªã th√¥ng b√°o, c√≥ th·ªÉ m·ªü r·ªông sau
    alert('Chi ti·∫øt ƒë∆°n h√†ng #' + orderId.substring(0, 8));
}
</script>
