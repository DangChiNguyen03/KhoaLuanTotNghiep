<div class="container">
    {{#if messages.success_msg}}
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        {{messages.success_msg}}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {{/if}}
    <h1 class="mb-4">Quản lý sản phẩm</h1>
    
    <!-- Add Product Button -->
    <button type="button" class="btn btn-primary mb-4" data-bs-toggle="modal" data-bs-target="#addProductModal">
        <i class="fas fa-plus me-2"></i>Thêm sản phẩm mới
    </button>

    <!-- Products Table -->
    <div class="table-responsive">
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Hình ảnh</th>
                    <th>Tên sản phẩm</th>
                    <th>Giá</th>
                    <th>Danh mục</th>
                    <th>Topping</th>
                    <th>Thao tác</th>
                </tr>
            </thead>
            <tbody>
                {{#each products}}
                <tr>
                    <td><img src="{{this.image}}" alt="{{this.name}}" style="width: 100px; height: 100px; object-fit: contain; background: #fff;"></td>
                    <td>{{this.name}}</td>
                    <td>
                        {{#if (eq this.category 'Topping')}}
                            {{#if this.price}}{{this.price}}đ{{else}}{{this.sizes.[0].price}}đ{{/if}}
                        {{else}}
                            S: {{this.sizes.[0].price}}đ | M: {{this.sizes.[1].price}}đ | L: {{this.sizes.[2].price}}đ
                        {{/if}}
                    </td>
                    <td>{{this.category}}</td>
                    <td>{{#if this.toppings}}{{this.toppings.join ", "}}{{/if}}</td>
                    <td>
                        <button class="btn btn-sm btn-info edit-product" data-id="{{this._id}}" data-bs-toggle="modal" data-bs-target="#editProductModal">
                            <i class="fas fa-edit"></i>
                        </button>
                        <form action="/admin/products/delete/{{this._id}}?_method=DELETE" method="POST" style="display: inline;" onsubmit="return confirm('Bạn có chắc chắn muốn xóa sản phẩm này?');">
                            <button type="submit" class="btn btn-sm btn-danger">
                                <i class="fas fa-trash"></i>
                            </button>
                        </form>
                    </td>
                </tr>
                {{/each}}
            </tbody>
        </table>
    </div>
</div>

<!-- Add Product Modal -->
<div class="modal fade" id="addProductModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Thêm sản phẩm mới</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addProductForm" enctype="multipart/form-data" method="POST" action="/admin/products">
                    <div class="mb-3">
                        <label class="form-label">Tên sản phẩm</label>
                        <input type="text" class="form-control" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Mô tả</label>
                        <textarea class="form-control" name="description" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Danh mục</label>
                        <select class="form-select" name="category" id="addCategorySelect" required>
                            <option value="Trà sữa">Trà sữa</option>
                            <option value="Trà trái cây">Trà trái cây</option>
                            <option value="Đá xay">Đá xay</option>
                            <option value="Topping">Topping</option>
                            <option value="Cà phê">Cà phê</option>
                            <option value="Nước ép">Nước ép</option>
                        </select>
                    </div>
                    
                    <div class="mb-3" id="addPriceSection" style="display: none;">
                        <label class="form-label">Giá sản phẩm</label>
                        <input type="number" class="form-control" name="price" min="0" placeholder="Giá sản phẩm">
                    </div>

                    <div class="mb-3" id="addSizeSection">
                        <label class="form-label">Giá theo kích cỡ</label>
                        <div class="row g-2">
                            <div class="col-4">
                                <input type="number" class="form-control" name="sizePriceS" placeholder="Giá S">
                            </div>
                            <div class="col-4">
                                <input type="number" class="form-control" name="sizePriceM" placeholder="Giá M">
                            </div>
                            <div class="col-4">
                                <input type="number" class="form-control" name="sizePriceL" placeholder="Giá L">
                            </div>
                        </div>
                    </div>

                    <div class="mb-3" id="addToppingSection">
                        <label class="form-label">Topping có sẵn</label>
                        <div class="row">
                            {{#each allToppings}}
                            <div class="col-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="toppings[]" value="{{this._id}}" id="add_topping_{{this._id}}">
                                    <label class="form-check-label" for="add_topping_{{this._id}}">{{this.name}}</label>
                                </div>
                            </div>
                            {{/each}}
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Hình ảnh</label>
                        <input type="file" class="form-control" name="image" accept="image/*">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                <button type="submit" form="addProductForm" class="btn btn-primary">Thêm</button>
            </div>
        </div>
    </div>
</div>


<!-- Edit Product Modal -->
<div class="modal fade" id="editProductModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Sửa sản phẩm</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editProductForm" enctype="multipart/form-data" method="POST">
                    <input type="hidden" name="productId">
                    <div class="mb-3">
                        <label class="form-label">Tên sản phẩm</label>
                        <input type="text" class="form-control" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Mô tả</label>
                        <textarea class="form-control" name="description" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Danh mục</label>
                        <select class="form-select" name="category" id="editCategorySelect" required>
                            <option value="Trà sữa">Trà sữa</option>
                            <option value="Trà trái cây">Trà trái cây</option>
                            <option value="Đá xay">Đá xay</option>
                            <option value="Topping">Topping</option>
                            <option value="Cà phê">Cà phê</option>
                            <option value="Nước ép">Nước ép</option>
                        </select>
                    </div>

                    <div class="mb-3" id="editPriceSection" style="display: none;">
                        <label class="form-label">Giá sản phẩm</label>
                        <input type="number" class="form-control" name="price" min="0" placeholder="Giá sản phẩm">
                    </div>

                    <div class="mb-3" id="editSizeSection">
                        <label class="form-label">Giá theo kích cỡ</label>
                        <div class="row g-2">
                            <div class="col-4">
                                <input type="number" class="form-control" name="sizePriceS" id="editSizePriceS" placeholder="Giá S">
                            </div>
                            <div class="col-4">
                                <input type="number" class="form-control" name="sizePriceM" id="editSizePriceM" placeholder="Giá M">
                            </div>
                            <div class="col-4">
                                <input type="number" class="form-control" name="sizePriceL" id="editSizePriceL" placeholder="Giá L">
                            </div>
                        </div>
                    </div>

                    <div class="mb-3" id="editToppingSection">
                        <label class="form-label">Topping có sẵn</label>
                        <div class="row">
                            {{#each allToppings}}
                            <div class="col-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="toppings[]" value="{{this._id}}" id="edit_topping_{{this._id}}">
                                    <label class="form-check-label" for="edit_topping_{{this._id}}">{{this.name}}</label>
                                </div>
                            </div>
                            {{/each}}
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Hình ảnh mới (không bắt buộc)</label>
                        <input type="file" class="form-control" name="image" accept="image/*">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                <button type="submit" form="editProductForm" class="btn btn-primary">Lưu thay đổi</button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    
    // --- LOGIC FOR ADD PRODUCT MODAL ---
    const addCategorySelect = document.getElementById('addCategorySelect');
    const addPriceSection = document.getElementById('addPriceSection');
    const addSizeSection = document.getElementById('addSizeSection');
    const addToppingSection = document.getElementById('addToppingSection');

    function toggleAddFormFields() {
        const isTopping = addCategorySelect.value === 'Topping';
        addPriceSection.style.display = isTopping ? 'block' : 'none';
        addSizeSection.style.display = isTopping ? 'none' : 'block';
        addToppingSection.style.display = isTopping ? 'none' : 'block';
    }
    addCategorySelect.addEventListener('change', toggleAddFormFields);
    toggleAddFormFields(); // Initial check

    // --- LOGIC FOR EDIT PRODUCT MODAL ---
    const editModal = document.getElementById('editProductModal');
    const editForm = document.getElementById('editProductForm');
    const editCategorySelect = document.getElementById('editCategorySelect');
    const editPriceSection = document.getElementById('editPriceSection');
    const editSizeSection = document.getElementById('editSizeSection');
    const editToppingSection = document.getElementById('editToppingSection');

    function toggleEditFormFields() {
        const isTopping = editCategorySelect.value === 'Topping';
        editPriceSection.style.display = isTopping ? 'block' : 'none';
        editSizeSection.style.display = isTopping ? 'none' : 'block';
        editToppingSection.style.display = isTopping ? 'none' : 'block';
    }
    editCategorySelect.addEventListener('change', toggleEditFormFields);

    // Handle opening the edit modal
    editModal.addEventListener('show.bs.modal', async function (event) {
        const button = event.relatedTarget;
        const productId = button.getAttribute('data-id');
        
        try {
            const response = await fetch(`/admin/products/${productId}`);
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            const product = await response.json();

            // Populate form
            editForm.action = `/admin/products/update/${productId}?_method=PUT`;
            editForm.querySelector('[name="productId"]').value = product._id;
            editForm.querySelector('[name="name"]').value = product.name || '';
            editForm.querySelector('[name="description"]').value = product.description || '';
            editForm.querySelector('[name="category"]').value = product.category || '';
            
            // Handle prices
            if (product.category === 'Topping') {
                const priceForTopping = product.price || (product.sizes && product.sizes[0] ? product.sizes[0].price : '');
                editForm.querySelector('[name="price"]').value = priceForTopping;
                editForm.querySelector('[name="sizePriceS"]').value = '';
                editForm.querySelector('[name="sizePriceM"]').value = '';
                editForm.querySelector('[name="sizePriceL"]').value = '';
            } else {
                const sizeS = product.sizes?.find(s => s.size === 'S')?.price || '';
                const sizeM = product.sizes?.find(s => s.size === 'M')?.price || '';
                const sizeL = product.sizes?.find(s => s.size === 'L')?.price || '';
                editForm.querySelector('[name="sizePriceS"]').value = sizeS;
                editForm.querySelector('[name="sizePriceM"]').value = sizeM;
                editForm.querySelector('[name="sizePriceL"]').value = sizeL;
                editForm.querySelector('[name="price"]').value = '';
            }
            
            // Handle toppings checkboxes
            const toppingCheckboxes = editForm.querySelectorAll('[name="toppings[]"]');
            toppingCheckboxes.forEach(checkbox => {
                checkbox.checked = product.toppings?.includes(checkbox.value) || false;
            });

            // Trigger the display logic after populating category
            toggleEditFormFields();

        } catch (error) {
            console.error('Failed to fetch product details:', error);
            alert('Không thể tải thông tin sản phẩm. Vui lòng thử lại.');
        }
    });

    // Clear form when modal is hidden to prevent stale data
    editModal.addEventListener('hidden.bs.modal', function () {
        editForm.reset();
        editForm.action = '';
    });
});
</script>