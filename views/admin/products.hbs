<div class="container">
    {{#if messages.success_msg}}
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        {{messages.success_msg}}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
{{/if}}
    <h1 class="mb-4">Quản lý sản phẩm</h1>
    
    <!-- Add Product Button -->
    <button type="button" class="btn btn-primary mb-4" data-bs-toggle="modal" data-bs-target="#addProductModal">
        <i class="fas fa-plus me-2"></i>Thêm sản phẩm mới
    </button>

    <!-- Products Table -->
    <div class="table-responsive">
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Hình ảnh</th>
                    <th>Tên sản phẩm</th>
                    <th>Giá</th>
                    <th>Danh mục</th>
                    <th>Topping</th>
                    <th>Thao tác</th>
                </tr>
            </thead>
            <tbody>
                {{#each products}}
                <tr>
                    <td><img src="{{image}}" alt="{{name}}" style="width: 100px; height: 100px; object-fit: contain; background: #fff;"></td>
                    <td>{{name}}</td>
                    <td>{{price}}đ</td>
                    <td>{{category}}</td>
                    <td>{{toppings.join ', '}}</td>
                    <td>
                        <button class="btn btn-sm btn-info edit-product" data-id="{{_id}}" data-bs-toggle="modal" data-bs-target="#editProductModal">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-danger delete-product" data-id="{{_id}}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
                {{/each}}
            </tbody>
        </table>
    </div>
</div>

<!-- Add Product Modal -->
<div class="modal fade" id="addProductModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Thêm sản phẩm mới</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addProductForm" enctype="multipart/form-data" method="POST" action="/admin/products">
                    <div class="mb-3">
                        <label class="form-label">Tên sản phẩm</label>
                        <input type="text" class="form-control" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Mô tả</label>
                        <textarea class="form-control" name="description" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Giá</label>
                        <input type="number" class="form-control" name="price" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Danh mục</label>
                        <select class="form-select" name="category" id="categorySelect" required>
                            <option value="Trà sữa">Trà sữa</option>
                            <option value="Trà trái cây">Trà trái cây</option>
                            <option value="Đá xay">Đá xay</option>
                            <option value="Topping">Topping</option>
                            <option value="Cà phê">Cà phê</option>
                            <option value="Nước ép">Nước ép</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Hình ảnh</label>
                        <input type="file" class="form-control" name="image" accept="image/*" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                <button type="submit" form="addProductForm" class="btn btn-primary">Thêm sản phẩm</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Product Modal -->
<div class="modal fade" id="editProductModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Sửa sản phẩm</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editProductForm" enctype="multipart/form-data">
                    <input type="hidden" name="productId">
                    <div class="mb-3">
                        <label class="form-label">Tên sản phẩm</label>
                        <input type="text" class="form-control" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Mô tả</label>
                        <textarea class="form-control" name="description" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Giá</label>
                        <input type="number" class="form-control" name="price" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Danh mục</label>
                        <select class="form-select" name="category" required>
                            <option value="Trà sữa">Trà sữa</option>
                            <option value="Trà trái cây">Trà trái cây</option>
                            <option value="Đá xay">Đá xay</option>
                            <option value="Topping">Topping</option>
                            <option value="Cà phê">Cà phê</option>
                            <option value="Nước ép">Nước ép</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Topping</label>
                        {{#each toppings}}
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="toppings[]" value="{{this}}" id="edit-topping-{{this}}">
                            <label class="form-check-label" for="edit-topping-{{this}}">{{this}}</label>
                        </div>
                        {{/each}}
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Hình ảnh mới (không bắt buộc)</label>
                        <input type="file" class="form-control" name="image" accept="image/*">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                <button type="submit" form="editProductForm" class="btn btn-primary">Lưu thay đổi</button>
            </div>
        </div>
    </div>
</div>

<script>
    console.log("Quản lý sản phẩm ADMIN đã load!");
document.addEventListener('DOMContentLoaded', function() {
    const categorySelect = document.getElementById('categorySelect');
    const toppingSection = document.getElementById('toppingSection');

    function toggleToppingSection() {
        if (!categorySelect || !toppingSection) return;
        if (categorySelect.value === 'Topping') {
            toppingSection.style.display = 'none';
        } else {
            toppingSection.style.display = 'block';
        }
    }

    if (categorySelect && toppingSection) {
        categorySelect.addEventListener('change', toggleToppingSection);
        toggleToppingSection();
    }

    const editButtons = document.querySelectorAll('.edit-product');
    editButtons.forEach(button => {
        button.addEventListener('click', async () => {
            const productId = button.dataset.id;
            try {
                const response = await fetch(`/admin/products/${productId}`);
                const product = await response.json();
                
                const form = document.getElementById('editProductForm');
                form.querySelector('[name="productId"]').value = product._id;
                form.querySelector('[name="name"]').value = product.name;
                form.querySelector('[name="description"]').value = product.description;
                form.querySelector('[name="price"]').value = product.price;
                form.querySelector('[name="category"]').value = product.category;
                
                const toppingCheckboxes = form.querySelectorAll('[name="toppings[]"]');
                toppingCheckboxes.forEach(checkbox => {
                    checkbox.checked = product.toppings.includes(checkbox.value);
                });
            } catch (err) {
                console.error('Lỗi khi lấy thông tin sản phẩm:', err);
                alert('Có lỗi xảy ra khi lấy thông tin sản phẩm');
            }
        });
    });

    const editProductForm = document.getElementById('editProductForm');
    editProductForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(editProductForm);
        const productId = formData.get('productId');
        
        try {
            const response = await fetch(`/admin/products/${productId}`, {
                method: 'PUT',
                body: formData
            });
            
            const result = await response.json();
            if (response.status === 200) {
                alert(result.message);
                window.location.reload();
            } else {
                alert(result.message || 'Có lỗi xảy ra khi cập nhật sản phẩm');
            }
        } catch (err) {
            console.error('Lỗi khi gửi yêu cầu cập nhật:', err);
            alert('Có lỗi xảy ra khi gửi yêu cầu');
        }
    });

    const deleteButtons = document.querySelectorAll('.delete-product');
    deleteButtons.forEach(button => {
        button.addEventListener('click', async () => {
            console.log('Đã click nút xóa', button.dataset.id);

            if (confirm('Bạn có chắc muốn xóa sản phẩm này?')) {
                const productId = button.dataset.id;
                try {
                    const response = await fetch(`/admin/products/${productId}`, {
                        method: 'DELETE'
                    });
                    
                    const result = await response.json();
                    if (response.status === 200) {
                        window.location.reload();
                    } else {
                        alert(result.message || 'Có lỗi xảy ra khi xóa sản phẩm');
                    }
                } catch (err) {
                    console.error('Lỗi khi gửi yêu cầu xóa:', err);
                    alert('Có lỗi xảy ra khi gửi yêu cầu');
                }
            }
        });
    });
});
</script>