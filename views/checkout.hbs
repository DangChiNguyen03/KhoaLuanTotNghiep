{{!< layouts/main}}
<div class="container">
    <h1 class="mb-4">Thanh toán</h1>

    {{#if success_msg}}
    <div class="alert alert-success">{{success_msg}}</div>
    {{/if}}
    {{#if error_msg}}
    <div class="alert alert-danger">{{error_msg}}</div>
    {{/if}}

    {{#if cart.length}}
    <div class="row">
        <div class="col-md-8">
            <h3>Chi tiết đơn hàng</h3>
            <div class="table-responsive mb-4">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Sản phẩm</th>
                            <th>Tùy chọn</th>
                            <th>Giá</th>
                            <th>Số lượng</th>
                            <th>Tổng</th>
                        </tr>
                    </thead>
                    <tbody>
                        {{#each cart}}
                        <tr>
                            <td>
                                <div class="d-flex align-items-center">
                                    <img src="{{product.image}}" alt="{{product.name}}" style="width: 50px; height: 50px; object-fit: cover;" class="me-3">
                                    <div>{{product.name}}</div>
                                </div>
                            </td>
                            <td>
                                <small>
                                    {{#if toppings.length}}
                                    <div>Topping:</div>
                                    <ul class="list-unstyled">
                                        {{#each toppingDetails}}
                                        <li>{{this.name}}</li>
                                        {{/each}}
                                    </ul>
                                    {{/if}}
                                    {{#if sugarLevel}}
                                    <div>Đường: {{sugarLevel}}</div>
                                    {{/if}}
                                    {{#if iceLevel}}
                                    <div>Đá: {{iceLevel}}</div>
                                    {{/if}}
                                </small>
                            </td>
                            <td>{{formatPrice product.price}}</td>
                            <td>{{quantity}}</td>
                            <td>{{formatPrice (multiply (add product.price (multiply toppings.length 10000)) quantity)}}</td>
                        </tr>
                        {{/each}}
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="4" class="text-end"><strong>Tổng cộng:</strong></td>
                            <td><strong>{{formatPrice totalPrice}}</strong></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
        <div class="col-md-4">
            <h3>Thông tin thanh toán</h3>
            <div class="card p-3">
                <p><strong>Họ tên:</strong> {{user.name}}</p>
                <p><strong>Email:</strong> {{user.email}}</p>
                <form method="POST" action="/cart/checkout" id="checkoutForm">
                    <div class="mb-3">
                        <label for="paymentMethod" class="form-label">Phương thức thanh toán</label>
                        <select class="form-select" id="paymentMethod" name="paymentMethod" required onchange="togglePaymentDetails()">
                            <option value="cash">Tiền mặt</option>
                            <option value="bank">Chuyển khoản ngân hàng</option>
                        </select>
                    </div>

                    <!-- Phần tiền mặt -->
                    <div id="cashDetails" style="display: block;">
                        <div class="mb-3">
                            <label for="cashAmount" class="form-label">Số tiền khách đưa (VNĐ)</label>
                            <input type="number" class="form-control" id="cashAmount" name="cashAmount" min="{{totalPrice}}" step="1000">
                        </div>
                        <div id="changeAmount" class="mb-3"></div>
                    </div>

                    <!-- Phần chuyển khoản -->
                    <div id="bankDetails" style="display: none;">
                        <p><strong>Thông tin tài khoản:</strong></p>
                        <p>Ngân hàng: MBbank</p>
                        <p>Số tài khoản: 0398154589</p>
                        <p>Chủ tài khoản: Nguyễn Phúc Thịnh</p>
                        <p>Vui lòng chuyển khoản với nội dung: "Thanh toán đơn hàng - {{user.email}}"</p>
                    </div>

                    <button type="submit" class="btn btn-primary w-100">Xác nhận thanh toán</button>
                </form>
            </div>
        </div>
    </div>
    {{else}}
    <div class="text-center">
        <p class="mb-4">Giỏ hàng trống</p>
        <a href="/products" class="btn btn-primary">Mua sắm ngay</a>
    </div>
    {{/if}}
</div>

<script>
function togglePaymentDetails() {
    const paymentMethod = document.getElementById('paymentMethod').value;
    const cashDetails = document.getElementById('cashDetails');
    const bankDetails = document.getElementById('bankDetails');

    if (paymentMethod === 'cash') {
        cashDetails.style.display = 'block';
        bankDetails.style.display = 'none';
    } else {
        cashDetails.style.display = 'none';
        bankDetails.style.display = 'block';
    }
}

document.addEventListener('DOMContentLoaded', function() {
    togglePaymentDetails();

    const cashAmountInput = document.getElementById('cashAmount');
    const totalPrice = {{totalPrice}};
    const changeAmountDiv = document.getElementById('changeAmount');

    cashAmountInput.addEventListener('input', function() {
        const cash = parseInt(this.value) || 0;
        const change = cash - totalPrice;
        if (change >= 0) {
            changeAmountDiv.innerHTML = `<strong>Tiền thừa:</strong> ${new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(change)}`;
        } else {
            changeAmountDiv.innerHTML = `<span class="text-danger">Số tiền không đủ</span>`;
        }
    });

    document.getElementById('checkoutForm').addEventListener('submit', function(e) {
        const paymentMethod = document.getElementById('paymentMethod').value;
        if (paymentMethod === 'cash') {
            const cash = parseInt(cashAmountInput.value) || 0;
            if (cash < totalPrice) {
                e.preventDefault();
                alert('Số tiền khách đưa không đủ để thanh toán!');
            }
        }
    });
});
</script>