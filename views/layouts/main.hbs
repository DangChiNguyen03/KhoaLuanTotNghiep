<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YOLOBrew</title>
    <!-- Bootstrap 5.3 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet"/>
    <link rel="stylesheet" href="/css/style.css">
</head>
<style>
    body{
        background: linear-gradient(to bottom, #fff1eb , #ace0f9);
    }
</style>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
        <div class="container">
            <a class="navbar-brand" href="/">YOLOBrew</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/">Trang chủ</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/products">Sản phẩm</a>
                    </li>
                </ul>
                <ul class="navbar-nav">
                    {{#if user}}
                        <li class="nav-item">
                            <a class="nav-link" href="/cart">
                                <i class="fas fa-shopping-cart"></i> Giỏ hàng
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/orders">
                                <i class="fas fa-receipt"></i> Đơn hàng của tôi
                            </a>
                        </li>
                        {{#if (eq user.role 'admin')}}
                            <li class="nav-item dropdown">
                                <a class="nav-link dropdown-toggle" href="#" id="adminDropdown" role="button" data-bs-toggle="dropdown">
                                    <i class="fas fa-cog"></i> Quản lý
                                </a>
                                <ul class="dropdown-menu" data-bs-auto-close="true">
                                    <li><a class="dropdown-item" href="/admin/dashboard" onclick="event.stopPropagation();">
                                        <i class="fas fa-chart-bar"></i> Dashboard
                                    </a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item" href="/admin/products" onclick="event.stopPropagation();">
                                        <i class="fas fa-box"></i> Sản phẩm
                                    </a></li>
                                    <li><a class="dropdown-item" href="/admin/orders" onclick="event.stopPropagation();">
                                        <i class="fas fa-shopping-cart"></i> Đơn hàng
                                    </a></li>
                                    <li><a class="dropdown-item" href="/admin/customers" onclick="event.stopPropagation();">
                                        <i class="fas fa-users"></i> Khách hàng
                                    </a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item" href="/admin/payments" onclick="event.stopPropagation();">
                                        <i class="fas fa-credit-card me-2"></i>Quản lý Thanh toán
                                    </a></li>
                                    <li><a class="dropdown-item" href="/admin/payment-methods" onclick="event.stopPropagation();">
                                        <i class="fas fa-money-check-alt me-2"></i>Phương thức Thanh toán
                                    </a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item" href="/admin/system-users" onclick="event.stopPropagation();">
                                        <i class="fas fa-users-cog me-2"></i>Quản lý Nhân viên
                                    </a></li>
                                    <li><a class="dropdown-item" href="/admin/login-logs" onclick="event.stopPropagation();">
                                        <i class="fas fa-shield-alt me-2"></i>Log Đăng nhập
                                    </a></li>
                                    <li><a class="dropdown-item" href="/admin/audit-logs" onclick="event.stopPropagation();">
                                        <i class="fas fa-clipboard-list me-2"></i>Audit Logs
                                    </a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item" href="/admin/reports/customers" onclick="event.stopPropagation();">
                                        <i class="fas fa-chart-bar me-2"></i>Báo cáo Khách hàng
                                    </a></li>
                                    <li><a class="dropdown-item" href="/admin/reports/payments" onclick="event.stopPropagation();">
                                        <i class="fas fa-credit-card me-2"></i>Báo cáo Thanh toán
                                    </a></li>
                                    <li><a class="dropdown-item" href="/admin/reports/products" onclick="event.stopPropagation();">
                                        <i class="fas fa-box me-2"></i>Báo cáo Sản phẩm
                                    </a></li>
                                    <li><a class="dropdown-item" href="/admin/reports/sales" onclick="event.stopPropagation();">
                                        <i class="fas fa-chart-line me-2"></i>Báo cáo Doanh số
                                    </a></li>
                                    <li><a class="dropdown-item" href="/admin/reports/system-users" onclick="event.stopPropagation();">
                                        <i class="fas fa-users-cog me-2"></i>Báo cáo Người dùng HT
                                    </a></li>
                                </ul>
                            </li>
                        {{/if}}
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown">
                                <i class="fas fa-user"></i> {{user.name}}
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li><a class="dropdown-item" href="/dashboard">Profile</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="/users/logout">Đăng xuất</a></li>
                            </ul>
                        </li>
                    {{else}}
                        <li class="nav-item">
                            <a class="nav-link" href="/users/login">Đăng nhập</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/users/register">Đăng ký</a>
                        </li>
                    {{/if}}
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        {{> messages}}
        {{{body}}}
    </div>

    {{> footer}}

    <!-- Bootstrap JS -->
    <!-- Chatbot Widget -->
    <div id="chatbot-widget" style="position: fixed; bottom: 20px; right: 20px; z-index: 9999;">
        <div id="chatbot-box" style="width: 350px; background: #fff; border-radius: 10px; box-shadow: 0 2px 16px rgba(0,0,0,0.18); display: none; flex-direction: column;">
            <div style="background: #007bff; color: #fff; padding: 10px 16px; border-radius: 10px 10px 0 0; font-weight: bold;">Tư vấn AI</div>
            <div id="chatbot-messages" style="padding: 12px; height: 220px; overflow-y: auto; font-size: 15px;"></div>
            <form id="chatbot-form" style="display: flex; border-top: 1px solid #eee;">
                <textarea id="chatbot-input" placeholder="Nhập câu hỏi..." autocomplete="off" style="flex: 1; border: none; padding: 10px; outline: none; font-size: 15px; resize: none; min-height: 38px; max-height: 100px; overflow-y: auto;"></textarea>
                <button type="submit" style="background: #007bff; color: #fff; border: none; padding: 0 16px; cursor: pointer;">Gửi</button>
            </form>
        </div>
        <button id="chatbot-toggle" style="background: #007bff; color: #fff; border: none; border-radius: 50%; width: 52px; height: 52px; font-size: 22px; box-shadow: 0 2px 8px rgba(0,0,0,0.15); cursor: pointer;">
            <i class="fas fa-comments"></i>
        </button>
    </div>
    <script>
        const chatbotToggle = document.getElementById('chatbot-toggle');
        const chatbotBox = document.getElementById('chatbot-box');
        const chatbotForm = document.getElementById('chatbot-form');
        const chatbotInput = document.getElementById('chatbot-input');
        const chatbotMessages = document.getElementById('chatbot-messages');

        chatbotToggle.onclick = () => {
            chatbotBox.style.display = chatbotBox.style.display === 'flex' ? 'none' : 'flex';
        };

        chatbotForm.onsubmit = async (e) => {
            e.preventDefault();
            const msg = chatbotInput.value.trim();
            if (!msg) return;
            chatbotMessages.innerHTML += `<div style='margin-bottom:6px;'><b>Bạn:</b> ${msg}</div>`;
            chatbotInput.value = '';
            chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
            try {
                const res = await fetch('/api/chatbot', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: msg })
                });
                const data = await res.json();
                if (data.reply) {
                    chatbotMessages.innerHTML += `<div style='margin-bottom:6px; color: #007bff;'><b>AI:</b> ${data.reply}</div>`;
                } else {
                    chatbotMessages.innerHTML += `<div style='color:red;'>AI không trả lời được. Vui lòng thử lại!</div>`;
                }
            } catch {
                chatbotMessages.innerHTML += `<div style='color:red;'>Lỗi kết nối AI. Vui lòng thử lại!</div>`;
            }
            chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
        };
    </script>
</body>
</html>
