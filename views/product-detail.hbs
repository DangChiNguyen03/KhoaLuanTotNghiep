<div class="container">
    <div class="row">
        <div class="col-md-6">
            <img src="{{product.image}}" class="img-fluid rounded" alt="{{product.name}}">
        </div>
        <div class="col-md-6">
            <h1 class="mb-4">{{product.name}}</h1>
            <p class="lead mb-4">{{product.description}}</p>
            <h3 class="mb-3"><span id="productPrice">{{#if product.sizes.length}}{{getPriceBySize product.sizes 'M'}}{{else}}{{product.price}}{{/if}}</span>đ</h3>

            {{#if product.toppings.length}}
            <div class="mb-4">
                <h4>Topping</h4>
                <ul class="list-unstyled">
                    {{#each product.toppings}}
                    <li>
                        <div class="form-check">
                            <input class="form-check-input topping-checkbox" type="checkbox" value="{{this}}" id="topping-{{@index}}">
                            <label class="form-check-label" for="topping-{{@index}}">
                                {{this}}
                            </label>
                        </div>
                    </li>
                    {{/each}}
                </ul>
            </div>
            {{/if}}

            {{#if product.sugarLevels.length}}
            <div class="mb-4">
                <h4>Độ ngọt</h4>
                <select class="form-select" id="sugarLevel">
                    {{#each product.sugarLevels}}
                    <option value="{{this}}">{{this}}</option>
                    {{/each}}
                </select>
            </div>
            {{/if}}

            {{#if product.iceLevels.length}}
            <div class="mb-4">
                <h4>Đá</h4>
                <select class="form-select" id="iceLevel">
                    {{#each product.iceLevels}}
                    <option value="{{this}}">{{this}}</option>
                    {{/each}}
                </select>
            </div>
            {{/if}}

            {{#if product.sizes.length}}
            <div class="mb-4">
                <h4>Kích cỡ</h4>
                {{#each product.sizes}}
                <div class="form-check form-check-inline">
                    <input class="form-check-input size-radio" type="radio" name="size" id="size-{{this.size}}" value="{{this.size}}" data-price="{{this.price}}" {{#if (eq this.size 'M')}}checked{{/if}}>
                    <label class="form-check-label" for="size-{{this.size}}">{{this.size}}</label>
                </div>
                {{/each}}
            </div>
            {{/if}}
            <div class="d-flex align-items-center mb-4">
                <div class="input-group me-3" style="width: 150px;">
                    <button class="btn btn-outline-secondary" type="button" id="decreaseQuantity">-</button>
                    <input type="number" class="form-control text-center" id="quantity" value="1" min="1">
                    <button class="btn btn-outline-secondary" type="button" id="increaseQuantity">+</button>
                </div>
                <button class="btn btn-primary" id="addToCart" data-product-id="{{product._id}}">
                    <i class="fas fa-shopping-cart me-2"></i>Thêm vào giỏ hàng
                </button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const quantityInput = document.getElementById('quantity');
    const decreaseBtn = document.getElementById('decreaseQuantity');
    const increaseBtn = document.getElementById('increaseQuantity');
    const addToCartBtn = document.getElementById('addToCart');

    // Xử lý tăng/giảm số lượng
    decreaseBtn.addEventListener('click', () => {
        const currentValue = parseInt(quantityInput.value);
        if (currentValue > 1) {
            quantityInput.value = currentValue - 1;
        }
    });
    
    increaseBtn.addEventListener('click', () => {
        const currentValue = parseInt(quantityInput.value);
        quantityInput.value = currentValue + 1;
    });

    // Xử lý thay đổi giá khi chọn size
    const priceSpan = document.getElementById('productPrice');
    const sizeRadios = document.querySelectorAll('.size-radio');
    if (sizeRadios && priceSpan) {
        sizeRadios.forEach(radio => {
            radio.addEventListener('change', function() {
                if (this.checked) {
                    priceSpan.textContent = this.getAttribute('data-price');
                }
            });
        });
    }

    // Xử lý thêm vào giỏ hàng
    addToCartBtn.addEventListener('click', () => {
        const productId = addToCartBtn.getAttribute('data-product-id');
        const quantity = parseInt(quantityInput.value);
        const toppings = Array.from(document.querySelectorAll('.topping-checkbox:checked')).map(cb => cb.value);
        const sugarLevel = document.getElementById('sugarLevel')?.value || '50%';
        const iceLevel = document.getElementById('iceLevel')?.value || '50%';
        let size = 'M';
        const sizeRadio = document.querySelector('input[name="size"]:checked');
        if (sizeRadio) size = sizeRadio.value;

        fetch('/cart/add', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                productId,
                quantity,
                toppings,
                sugarLevel,
                iceLevel,
                size
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.message === 'Thêm vào giỏ hàng thành công') {
                alert('Đã thêm vào giỏ hàng!');
                // Tùy chọn: Chuyển hướng tới trang giỏ hàng
                // window.location.href = '/cart';
            } else {
                alert('Có lỗi: ' + data.message);
            }
        })
        .catch(err => {
            console.error('Lỗi:', err);
            alert('Có lỗi xảy ra khi thêm vào giỏ hàng');
        });
    });
});
</script>